// ✅ PayApp 연동 정보 - 진짜 정확한 값으로 수정!
const PAYAPP_CONFIG = {
  userid: 'kstore101',
  linkkey: 'CCiZIswPVKh+xt+QKt/+b+1DPJnCCRVaOgT+oqg6zaM=',    // ✅ 정확한 값!
  linkval: 'CCiZIswPVKh+xt+QKt/+bxTdEGsBOXZ7gUSUjzGppZM='     // ✅ 정확한 값!
};

const SHEET_ID = '1ogVkRidiKcL2fcn9DTgPFlCp-nehjDZMRhx7EJqKIr0';

function doGet(e) {
  try {
    const action = e.parameter.action;
    console.log('doGet 호출됨:', action);
    
    if (action === 'paymentComplete') {
      return handlePaymentComplete(e.parameter);
    }
    
    return HtmlService.createHtmlOutput(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>LittleScienceAI</title>
        <meta charset="UTF-8">
        <style>
          body { font-family: Arial; text-align: center; padding: 50px; background: #f8f9fa; }
          .info { background: white; padding: 30px; border-radius: 15px; max-width: 400px; margin: 0 auto; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        </style>
      </head>
      <body>
        <div class="info">
          <h1>🧪 LittleScienceAI</h1>
          <p>과학논문 주제 탐색 도우미</p>
          <p><a href="https://little-science-ai-918631854597.asia-northeast3.run.app/">메인 페이지로 이동</a></p>
        </div>
      </body>
      </html>
    `);
  } catch (error) {
    console.error('doGet 에러:', error);
    return createErrorPage('페이지 로드 중 오류가 발생했습니다.');
  }
}

function doPost(e) {
  try {
    console.log('=== doPost 호출됨 ===');
    console.log('전체 파라미터:', JSON.stringify(e.parameter));
    
    if (e.parameter.pay_state || e.parameter.mul_no || e.parameter.userid) {
      console.log('✅ PayApp 콜백 감지');
      return handlePaymentCallback(e);
    }
    
    const action = e.parameter.action;
    if (action === 'paymentCallback') {
      return handlePaymentCallback(e);
    }
    
    if (action === 'paymentComplete') {
      return handlePaymentComplete(e.parameter);
    }
    
    console.log('❌ 알 수 없는 요청');
    return createErrorPage('잘못된 요청입니다.');
    
  } catch (error) {
    console.error('doPost 에러:', error);
    return createErrorPage('서버 오류: ' + error.toString());
  }
}

function isDuplicateOrder(orderNumber, payappOrderNumber = null) {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][9] === orderNumber) {
        console.log(`⚠️ 중복 처리 방지: 주문번호 ${orderNumber} 이미 처리됨`);
        return true;
      }
      
      if (payappOrderNumber && data[i][13] === payappOrderNumber) {
        console.log(`⚠️ 중복 처리 방지: PayApp 주문번호 ${payappOrderNumber} 이미 처리됨`);
        return true;
      }
    }
    return false;
  } catch (error) {
    console.error('중복 체크 오류:', error);
    return false;
  }
}

function handlePaymentCallback(e) {
  try {
    console.log('=== PayApp 결제 콜백 받음 ===');
    
    // ✅ 유연한 보안 검증 (linkval이 없으면 통과, 있는데 틀리면 FAIL)
    const receivedLinkval = e.parameter.linkval;
    if (receivedLinkval && receivedLinkval !== PAYAPP_CONFIG.linkval) {
      console.error('⚠️ PayApp 보안 검증 실패 - linkval 불일치');
      console.error(`받은 값: "${receivedLinkval}"`);
      console.error(`예상 값: "${PAYAPP_CONFIG.linkval}"`);
      return HtmlService.createHtmlOutput('FAIL'); // ✅ HtmlService 사용
    }
    console.log('✅ PayApp 보안 검증 성공 (또는 linkval 없음)');
    
    const payResult = {
      pay_state: e.parameter.pay_state,
      var1: e.parameter.var1,
      var2: e.parameter.var2,
      mul_no: e.parameter.mul_no,
      pay_price: e.parameter.pay_price,
      pay_type: e.parameter.pay_type,
      pay_time: e.parameter.pay_time
    };
    
    console.log(`결제 상태: ${payResult.pay_state}`);
    console.log(`주문번호: ${payResult.var1}`);
    console.log(`PayApp 주문번호: ${payResult.mul_no}`);
    
    // ✅ 예전 방식처럼 더 관대한 결제 상태 체크
    const payState = payResult.pay_state;
    console.log(`결제 상태 확인: "${payState}" (타입: ${typeof payState})`);
    
    // Y, '4', 4 모든 경우를 결제 성공으로 처리 (예전 방식)
    if (payState === 'Y' || payState === '4' || payState === 4) {
      console.log('✅ 결제 완료 확인됨 - 이용권 발급 시작');
    } else {
      console.log(`❌ 결제 미완료 상태: ${payState} - SUCCESS 응답하고 종료`);
      return HtmlService.createHtmlOutput('SUCCESS'); // ✅ HtmlService 사용
    }

    const orderNumber = payResult.var1 || `AUTO_${new Date().getTime()}`;
    const payappOrderNumber = payResult.mul_no;
    
    if (isDuplicateOrder(orderNumber, payappOrderNumber)) {
      console.log('이미 처리된 주문 - SUCCESS 응답');
      return HtmlService.createHtmlOutput('SUCCESS'); // ✅ HtmlService 사용
    }
    
    console.log('✅ 새로운 주문 - 이용권 발급 진행');
      
    let orderInfo;
    try {
      if (payResult.var2) {
        orderInfo = JSON.parse(payResult.var2);
        console.log('✅ orderData 파싱 성공:', orderInfo);
      } else {
        console.warn('⚠️ orderData 없음 - 기본값 사용');
        orderInfo = {
          email: 'jonghyeuk@gmail.com',
          license: '7일 이용권',
          price: 7500
        };
      }
    } catch (parseError) {
      console.error('❌ 주문 데이터 파싱 오류:', parseError);
      orderInfo = {
        email: 'jonghyeuk@gmail.com',
        license: '7일 이용권',
        price: 7500
      };
    }
    
    const result = purchaseLicense(orderInfo.license, orderInfo.email, {
      orderNumber: orderNumber,
      payappOrderNumber: payappOrderNumber,
      payType: payResult.pay_type || 'unknown',
      payTime: payResult.pay_time || new Date().toISOString(),
      payPrice: payResult.pay_price || orderInfo.price
    });
    
    console.log('🎫 이용권 발급 결과:', result);
    
    if (result.success) {
      console.log('✅ PayApp 결제 완료 - 이용권 발급 성공:', result.code);
    } else {
      console.error('❌ 이용권 발급 실패:', result.message);
    }
    
    // ✅ 모든 경우에 예쁜 SUCCESS 페이지로 응답
    return HtmlService.createHtmlOutput(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>결제 처리 완료</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          body { 
            font-family: 'Segoe UI', sans-serif; 
            text-align: center; 
            padding: 50px; 
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
          }
          .success { 
            background: white; 
            padding: 40px; 
            border-radius: 20px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
            display: inline-block;
            max-width: 500px;
            animation: slideIn 0.5s ease-out;
          }
          @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
          }
          .check-icon {
            font-size: 80px;
            color: #28a745;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out;
          }
          @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
          }
          h1 { color: #333; margin-bottom: 20px; }
          p { color: #666; margin: 15px 0; line-height: 1.6; }
          .email-info {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #28a745;
          }
          .main-btn {
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
          }
          .main-btn:hover {
            background: #218838;
            transform: translateY(-2px);
          }
        </style>
      </head>
      <body>
        <div class="success">
          <div class="check-icon">✅</div>
          <h1>🎉 결제 완료!</h1>
          
          <div class="email-info">
            <p><strong>📧 이용권 코드가 이메일로 발송되었습니다!</strong></p>
            <p>LittleScienceAI <strong>7일 이용권</strong></p>
          </div>
          
          <p style="color: #28a745; font-weight: bold;">✨ 결제가 성공적으로 처리되었습니다</p>
          <p>📱 잠시 후 이메일을 확인해주세요</p>
          
          <a href="https://little-science-ai-918631854597.asia-northeast3.run.app/" class="main-btn">🧪 LittleScienceAI 시작하기</a>
          
          <p style="margin-top: 30px; font-size: 12px; color: #999;">
            💌 이메일이 도착하지 않으면 스팸함을 확인해주세요<br>
            🆘 문의: 카카오톡 채널 '리틀사이언스AI'
          </p>
        </div>
        
        <script>
          // 3초 후 메인 페이지로 자동 이동
          setTimeout(() => {
            window.location.href = 'https://little-science-ai-918631854597.asia-northeast3.run.app/';
          }, 3000);
        </script>
      </body>
      </html>
    `);
    
  } catch (error) {
    console.error('💥 PayApp 콜백 처리 오류:', error);
    return HtmlService.createHtmlOutput('SUCCESS'); // ✅ HtmlService 사용
  }
}

function handlePaymentComplete(params) {
  try {
    const email = params.email;
    const license = params.license;
    
    console.log(`결제 완료 페이지: ${email}, ${license}`);
    
    const html = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>결제 완료</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          body { 
            font-family: 'Segoe UI', sans-serif; 
            text-align: center; 
            padding: 50px; 
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
          }
          .success { 
            background: white; 
            padding: 40px; 
            border-radius: 20px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
            display: inline-block;
            max-width: 500px;
          }
          .check-icon {
            font-size: 80px;
            color: #28a745;
            margin-bottom: 20px;
          }
          h1 { color: #333; margin-bottom: 20px; }
          p { color: #666; margin: 15px 0; line-height: 1.6; }
          .email-info {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #28a745;
          }
          .main-btn {
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
          }
          .steps {
            text-align: left;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
          }
          .steps h3 {
            color: #28a745;
            margin-bottom: 15px;
            text-align: center;
          }
          .steps ol {
            color: #666;
            line-height: 1.8;
          }
        </style>
      </head>
      <body>
        <div class="success">
          <div class="check-icon">✅</div>
          <h1>결제 완료!</h1>
          
          <div class="email-info">
            <p><strong>📧 ${email}</strong></p>
            <p><strong>${license}</strong> 이용권 코드가<br>이메일로 발송되었습니다!</p>
          </div>
          
          <div class="steps">
            <h3>🚀 이용 방법</h3>
            <ol>
              <li><strong>이메일 확인</strong> - 발송된 이용권 코드 확인</li>
              <li><strong>사이트 접속</strong> - LittleScienceAI 메인 페이지 방문</li>
              <li><strong>코드 입력</strong> - 인증 키 메뉴에서 코드 입력</li>
              <li><strong>탐색 시작</strong> - 과학 논문 주제 탐색 시작!</li>
            </ol>
          </div>
          
          <a href="https://little-science-ai-918631854597.asia-northeast3.run.app/" class="main-btn">🧪 LittleScienceAI 시작하기</a>
          
          <p style="margin-top: 30px; font-size: 12px; color: #999;">
            💌 이메일이 도착하지 않으면 스팸함을 확인해주세요.<br>
            🆘 문의: 카카오톡 채널 '리틀사이언스AI'
          </p>
        </div>
      </body>
      </html>
    `;
    
    return HtmlService.createHtmlOutput(html);
    
  } catch (error) {
    console.error('결제 완료 페이지 오류:', error);
    return createErrorPage('페이지 로드 중 오류가 발생했습니다.');
  }
}

function purchaseLicense(licenseType, buyerEmail, paymentInfo = null) {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    console.log(`이용권 발급: ${licenseType}, ${buyerEmail}`);
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === licenseType && data[i][4] === '') {
        
        console.log(`사용 가능한 코드 발견: ${data[i][0]}`);
        
        sheet.getRange(i + 1, 8).setValue(buyerEmail);
        sheet.getRange(i + 1, 9).setValue(new Date());
        
        if (paymentInfo) {
          sheet.getRange(i + 1, 10).setValue(paymentInfo.orderNumber);
          sheet.getRange(i + 1, 11).setValue(paymentInfo.payType);
          sheet.getRange(i + 1, 12).setValue(paymentInfo.payPrice);
          sheet.getRange(i + 1, 13).setValue(paymentInfo.payTime);
          
          if (paymentInfo.payappOrderNumber) {
            sheet.getRange(i + 1, 14).setValue(paymentInfo.payappOrderNumber);
          }
        }
        
        const code = data[i][0];
        sendCodeEmail(code, licenseType, buyerEmail, paymentInfo);
        
        console.log(`이용권 발급 성공: ${code} → ${buyerEmail}`);
        
        return {
          success: true,
          code: code,
          message: 'PayApp 결제 완료! 이메일을 확인해주세요.'
        };
      }
    }
    
    console.log(`재고 부족: ${licenseType}`);
    return {
      success: false,
      message: `${licenseType} 재고가 부족합니다.`
    };
    
  } catch (error) {
    console.error('이용권 발급 오류:', error);
    return {
      success: false,
      message: '시스템 오류: ' + error.toString()
    };
  }
}

function sendCodeEmail(code, licenseType, buyerEmail, paymentInfo = null) {
  try {
    const subject = `[LittleScienceAI] ${licenseType} 발급 완료 (PayApp 결제)`;
    
    const htmlBody = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>이용권 발급 안내</title>
    </head>
    <body style="font-family: Arial; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
      
      <div style="background: #28a745; color: white; padding: 30px; text-align: center; border-radius: 10px;">
        <h1 style="margin: 0; font-size: 28px;">LittleScienceAI</h1>
        <p style="margin: 10px 0 0 0; font-size: 18px;">PayApp 결제 완료 및 이용권 발급</p>
      </div>
      
      <div style="margin: 30px 0;">
        <h2 style="color: #28a745;">결제가 완료되었습니다! 🎉</h2>
        <p>LittleScienceAI를 구매해주셔서 감사합니다.</p>
        
        <div style="background: #f5f5f5; border: 3px solid #28a745; padding: 25px; text-align: center; border-radius: 10px; margin: 25px 0;">
          <p style="margin: 0; color: #666;">귀하의 이용권 코드</p>
          <h1 style="margin: 15px 0; color: #28a745; font-size: 32px; letter-spacing: 2px;">${code}</h1>
          <p style="margin: 0; color: #666; font-weight: bold;">${licenseType}</p>
        </div>
        
        <div style="background: #e8f4fd; padding: 20px; border-radius: 8px; margin: 25px 0;">
          <h3 style="margin-top: 0; color: #2e7d32;">🚀 사용 방법</h3>
          <p><strong>1단계:</strong> LittleScienceAI 웹사이트에 접속</p>
          <p><strong>2단계:</strong> 인증 키 입력 메뉴 선택</p>
          <p><strong>3단계:</strong> 위의 코드를 입력</p>
          <p><strong>4단계:</strong> 과학 논문 탐색 시작!</p>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
          <a href="https://little-science-ai-918631854597.asia-northeast3.run.app/" style="background: #28a745; color: white; padding: 15px 35px; text-decoration: none; border-radius: 25px; font-size: 16px; font-weight: bold;">지금 바로 시작하기</a>
        </div>
      </div>
      
      <div style="border-top: 1px solid #ddd; padding-top: 20px; text-align: center; color: #666;">
        <p>안전한 PayApp 결제 시스템을 이용해주셔서 감사합니다.</p>
        <p>문의사항이 있으시면 카카오톡 채널 '리틀사이언스AI'로 연락주세요.</p>
        <p><strong>LittleScienceAI 팀</strong></p>
      </div>
      
    </body>
    </html>
    `;
    
    const textBody = `
LittleScienceAI ${licenseType} 발급 완료 (PayApp 결제)

🎉 결제가 완료되었습니다!
LittleScienceAI를 구매해주셔서 감사합니다.

🎫 이용권 코드: ${code}
⏰ 이용기간: ${licenseType}
🔗 접속 링크: https://little-science-ai-918631854597.asia-northeast3.run.app/

📝 이용 방법:
1. 위 링크로 접속
2. 인증 키에 코드 입력: ${code}
3. 과학 논문 탐색 시작!

💡 이용권 코드는 안전하게 보관해주세요.

감사합니다.
LittleScienceAI 팀
    `;
    
    GmailApp.sendEmail(
      buyerEmail, 
      subject, 
      textBody,
      {
        htmlBody: htmlBody
      }
    );
    
    console.log(`이메일 발송: ${buyerEmail}`);
    
  } catch (error) {
    console.error('이메일 발송 오류:', error);
  }
}

function createErrorPage(message) {
  const html = `
  <!DOCTYPE html>
  <html>
  <head>
    <title>오류 발생</title>
    <meta charset="UTF-8">
    <style>
      body { 
        font-family: Arial; 
        text-align: center; 
        padding: 50px; 
        background: #ffe6e6;
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .error { 
        background: white; 
        padding: 40px; 
        border-radius: 20px; 
        max-width: 500px;
      }
      h1 { color: #e74c3c; }
      p { color: #666; }
    </style>
  </head>
  <body>
    <div class="error">
      <h1>⚠️ 오류 발생</h1>
      <p>${message}</p>
    </div>
  </body>
  </html>
  `;
  
  return HtmlService.createHtmlOutput(html);
}

function emergencyIssueLicense() {
  const buyerEmail = 'jonghyeuk@gmail.com';
  const licenseType = '7일 이용권';
  const paymentAmount = 7500;
  
  console.log('=== 긴급 수동 이용권 발급 시작 ===');
  
  const paymentInfo = {
    orderNumber: 'EMERGENCY_' + Date.now(),
    payType: 'card',
    payTime: new Date().toISOString(),
    payPrice: paymentAmount,
    manual: true
  };
  
  const result = purchaseLicense(licenseType, buyerEmail, paymentInfo);
  console.log('긴급 발급 결과:', result);
  
  return result;
}

function checkStock() {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    const stock = {
      '7일 이용권': 0,
      '15일 이용권': 0,
      '30일 이용권': 0
    };
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][4] === '') {
        const type = data[i][1];
        if (stock.hasOwnProperty(type)) {
          stock[type]++;
        }
      }
    }
    
    console.log('현재 재고 현황:', stock);
    return stock;
    
  } catch (error) {
    console.error('재고 확인 오류:', error);
    return null;
  }
}
