// ğŸš€ LittleScienceAI + PayApp ìë™ êµ¬ë§¤ ì‹œìŠ¤í…œ ë°±ì—”ë“œ (ë¬¸ì œì  ìˆ˜ì • ë²„ì „)

// ğŸ”§ ì„¤ì •ê°’ë“¤ (ê¸°ì¡´ ìœ ì§€)
const CONFIG = {
  SHEET_ID: '1ogVkRidiKcL2fcn9DTgPFlCp-nehjDZMRhx7EJqKIr0',
  PAYAPP_USERID: 'kstore101',
  PAYAPP_LINKKEY: 'CCiZIswPVKh+xt+QKt/+b+1DPJnCCRVaOgT+oqg6zaM=',
  PAYAPP_LINKVAL: 'CCiZIswPVKh+xt+QKt/+bxTdEGsBOXZ7gUSUjzGppZM=',
  FEEDBACK_URL: 'https://script.google.com/macros/s/AKfycbzOF3yUJXY22nUckDBvPmNdAzSZjAjEJDi4mcPwu_54t7gLRham0V6nst-JQVRHZrrf/exec'
};

const PRICE_MAP = {
  '7ì¼ ì´ìš©ê¶Œ': 5900,
  '15ì¼ ì´ìš©ê¶Œ': 9900,
  '30ì¼ ì´ìš©ê¶Œ': 12900
};

// ğŸ”§ URL íŒŒë¼ë¯¸í„° íŒŒì‹± í•¨ìˆ˜
function parseQueryString(queryString) {
  const params = {};
  if (!queryString) return params;
  
  const pairs = queryString.split('&');
  for (let i = 0; i < pairs.length; i++) {
    const pair = pairs[i].split('=');
    if (pair.length === 2) {
      const key = decodeURIComponent(pair[0]);
      const value = decodeURIComponent(pair[1]);
      params[key] = value;
    }
  }
  return params;
}

// ğŸ”— FeedbackURL ë°˜í™˜
function getFeedbackUrl() {
  return CONFIG.FEEDBACK_URL;
}

// ğŸ“ ë©”ì¸ POST ì²˜ë¦¬ í•¨ìˆ˜ (ğŸ”¥ í•µì‹¬ ìˆ˜ì •)
function doPost(e) {
  try {
    let data;
    
    if (e.postData && e.postData.contents) {
      try {
        data = JSON.parse(e.postData.contents);
      } catch (jsonError) {
        data = e.parameter;
      }
    } else {
      data = e.parameter;
    }
    
    console.log('ë°›ì€ ë°ì´í„°:', data);
    
    // ğŸ”¥ ëª…í™•í•œ ìš”ì²­ êµ¬ë¶„ìœ¼ë¡œ ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜ ë°©ì§€
    // 1. êµ¬ë§¤ ìš”ì²­ ì²˜ë¦¬ (ìš°ì„ ìˆœìœ„)
    if (data.action === 'purchase') {
      console.log('êµ¬ë§¤ ìš”ì²­ ì²˜ë¦¬ ì‹œì‘');
      const reservationResult = purchaseLicense(data.licenseType, data.buyerEmail);
      
      if (reservationResult.success) {
        const payAppResult = requestPayAppPayment(
          data.licenseType, 
          data.buyerEmail,
          data.buyerPhone,
          reservationResult.code, 
          reservationResult.token,
          reservationResult.rowIndex
        );
        
        if (payAppResult.success) {
          const html = createRedirectPage(payAppResult.payUrl, payAppResult.mulNo);
          return HtmlService.createHtmlOutput(html);
        } else {
          return HtmlService.createHtmlOutput(createErrorPageHtml(payAppResult.message));
        }
      } else {
        return HtmlService.createHtmlOutput(createErrorPageHtml(reservationResult.message));
      }
    }
    
    // 2. PayApp ì½œë°± ì²˜ë¦¬
    if (data.userid && data.linkval && data.mul_no) {
      console.log('PayApp ì½œë°± ì²˜ë¦¬ ì‹œì‘');
      const result = handlePayAppCallback(data);
      return ContentService.createTextOutput(result).setMimeType(ContentService.MimeType.TEXT);
    }
    
    // 3. ì•Œ ìˆ˜ ì—†ëŠ” ìš”ì²­
    console.log('ì•Œ ìˆ˜ ì—†ëŠ” ìš”ì²­:', data);
    return HtmlService.createHtmlOutput(createErrorPageHtml('ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤.'));
      
  } catch (error) {
    console.error('doPost ì—ëŸ¬:', error);
    // ğŸ”¥ ëª¨ë“  ì—ëŸ¬ë„ HTMLë¡œ ë°˜í™˜
    return HtmlService.createHtmlOutput(createErrorPageHtml('ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.toString()));
  }
}

// ğŸ“ GET ìš”ì²­ ì²˜ë¦¬ í•¨ìˆ˜ (ë””ë²„ê¹…ìš©)
function doGet(e) {
  console.log('GET ìš”ì²­ ë°›ìŒ:', e.parameter);
  
  const html = '<!DOCTYPE html><html><head><title>LittleScienceAI ë°±ì—”ë“œ</title><meta charset="UTF-8"></head><body><h1>ğŸ§ª LittleScienceAI ë°±ì—”ë“œ</h1><p>ë°±ì—”ë“œê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤!</p><p><strong>ì£¼ì˜:</strong> ì´ í˜ì´ì§€ëŠ” GET ìš”ì²­ ê²°ê³¼ì…ë‹ˆë‹¤.</p><p>êµ¬ë§¤ëŠ” í”„ë¡ íŠ¸ì—”ë“œ HTML í˜ì´ì§€ì—ì„œ POST ìš”ì²­ìœ¼ë¡œ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤.</p><hr><h3>ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ</h3><ul><li>âœ… Google Apps Script ì‘ë™</li><li>âœ… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²°</li><li>âœ… PayApp ì„¤ì • ì™„ë£Œ</li></ul></body></html>';
  
  return HtmlService.createHtmlOutput(html);
}

// ğŸ« ë¼ì´ì„¼ìŠ¤ êµ¬ë§¤ ì˜ˆì•½ (ğŸ”¥ ìˆœí™˜ ê²€ìƒ‰ ë¡œì§ ì ìš©)
function purchaseLicense(licenseType, buyerEmail) {
  try {
    const sheet = SpreadsheetApp.openById(CONFIG.SHEET_ID).getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    console.log('êµ¬ë§¤ ìš”ì²­:', licenseType, buyerEmail);
    
    // ì§„í–‰ ì¤‘ì¸ ê±°ë˜ ì¤‘ë³µ ì²´í¬ (1ë¶„ ë‚´)
    const oneMinuteAgo = new Date(Date.now() - 1 * 60 * 1000);
    for (let i = 1; i < data.length; i++) {
      if (data[i][8] === buyerEmail &&  // ğŸ”¥ 7 â†’ 8ìœ¼ë¡œ ìˆ˜ì • (Iì—´ì´ ì´ë©”ì¼)
          (data[i][9] === 'PENDING' || data[i][9] === 'PAYAPP_REQUESTED')) {
        
        if (data[i][8] && new Date(data[i][8]) > oneMinuteAgo) {
          return {
            success: false,
            message: 'ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì¸ ê²°ì œê°€ ìˆìŠµë‹ˆë‹¤. 1ë¶„ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
          };
        }
      }
    }
    
    // ğŸ”¥ ê°œì„ ëœ ì¬ê³  ì°¾ê¸°: ìˆœí™˜ ê²€ìƒ‰ (ëê¹Œì§€ ê°€ë©´ ì²˜ìŒë¶€í„° ë‹¤ì‹œ)
    const availableRows = [];
    
    // 1ë‹¨ê³„: í•´ë‹¹ íƒ€ì…ì˜ ëª¨ë“  ì‚¬ìš© ê°€ëŠ¥í•œ ì½”ë“œ ìˆ˜ì§‘
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === licenseType && data[i][4] === '' && 
          (!data[i][9] || data[i][9] === '')) {
        availableRows.push({
          rowIndex: i + 1,
          code: data[i][0]
        });
      }
    }
    
    console.log('ì‚¬ìš© ê°€ëŠ¥í•œ', licenseType, 'ì½”ë“œ ê°œìˆ˜:', availableRows.length);
    
    if (availableRows.length === 0) {
      console.log('ì¬ê³  ë¶€ì¡±:', licenseType);
      return {
        success: false,
        message: licenseType + ' ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.'
      };
    }
    
    // 2ë‹¨ê³„: ë§ˆì§€ë§‰ ì‚¬ìš©ëœ í–‰ ë‹¤ìŒë¶€í„° í• ë‹¹ (ìˆœí™˜)
    let selectedRow = null;
    
    // ë§ˆì§€ë§‰ ì‚¬ìš©ëœ í–‰ ì°¾ê¸°
    let lastUsedRowIndex = 0;
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === licenseType && data[i][4] !== '') {
        lastUsedRowIndex = Math.max(lastUsedRowIndex, i);
      }
    }
    
    console.log('ë§ˆì§€ë§‰ ì‚¬ìš©ëœ í–‰:', lastUsedRowIndex);
    
    // ë§ˆì§€ë§‰ ì‚¬ìš©ëœ í–‰ ë‹¤ìŒë¶€í„° ì°¾ê¸°
    for (let i = 0; i < availableRows.length; i++) {
      if (availableRows[i].rowIndex > lastUsedRowIndex) {
        selectedRow = availableRows[i];
        break;
      }
    }
    
    // ì°¾ì§€ ëª»í–ˆìœ¼ë©´ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì°¾ê¸° (ìˆœí™˜)
    if (!selectedRow) {
      selectedRow = availableRows[0];
      console.log('ëê¹Œì§€ ê°”ìœ¼ë¯€ë¡œ ì²˜ìŒë¶€í„° í• ë‹¹:', selectedRow.code);
    } else {
      console.log('ìˆœì°¨ í• ë‹¹:', selectedRow.code);
    }
    
    const uniqueToken = Utilities.getUuid();
    updatePaymentStatus(selectedRow.rowIndex, 'PENDING', '', uniqueToken);
    
    sheet.getRange(selectedRow.rowIndex, 9).setValue(buyerEmail);  // ğŸ”¥ 8 â†’ 9ë¡œ ìˆ˜ì • (Iì—´ì— ì´ë©”ì¼)
    sheet.getRange(selectedRow.rowIndex, 10).setValue(new Date()); // ğŸ”¥ 9 â†’ 10ìœ¼ë¡œ ìˆ˜ì • (Jì—´ì— ë‚ ì§œ)
    
    console.log('ì˜ˆì•½ ì™„ë£Œ:', selectedRow.code, 'â†’', buyerEmail, '(í† í°:', uniqueToken, ')');
    
    return {
      success: true,
      code: selectedRow.code,
      token: uniqueToken,
      message: 'ì˜ˆì•½ ì™„ë£Œ. PayApp ê²°ì œë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.',
      rowIndex: selectedRow.rowIndex
    };
    
  } catch (error) {
    console.error('êµ¬ë§¤ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    return {
      success: false,
      message: 'ì‹œìŠ¤í…œ ì˜¤ë¥˜: ' + error.toString()
    };
  }
}

// ğŸ’³ PayApp ê²°ì œ ìš”ì²­ (ğŸ”¥ checkretry ìˆ˜ì •)
function requestPayAppPayment(licenseType, buyerEmail, buyerPhone, code, token, rowIndex) {
  try {
    updatePaymentStatus(rowIndex, 'PAYAPP_REQUESTED', '', token);
    
    const price = PRICE_MAP[licenseType];
    
    const payload = {
      'cmd': 'payrequest',
      'userid': CONFIG.PAYAPP_USERID,
      'goodname': 'LittleScienceAI ' + licenseType,
      'price': price.toString(),
      'recvphone': buyerPhone,
      'memo': 'LittleScienceAI ' + licenseType + ' êµ¬ë§¤ (' + buyerEmail + ')',
      'feedbackurl': getFeedbackUrl(),
      'var1': token,
      'var2': code,
      'checkretry': 'n',  // ğŸ”¥ 'y' â†’ 'n' ë³€ê²½ (ì¬ì‹œë„ ë¹„í™œì„±í™”)
      'smsuse': 'n',
      'popupyn': 'y',
      'windowmode': 'popup',
      'frameyn': 'n'
    };
    
    console.log('PayApp ìš”ì²­ ë°ì´í„°:', payload);
    
    const response = UrlFetchApp.fetch('https://api.payapp.kr/oapi/apiLoad.html', {
      'method': 'POST',
      'payload': payload,
      'muteHttpExceptions': true
    });
    
    const responseText = response.getContentText();
    console.log('PayApp ì‘ë‹µ:', responseText);
    
    const params = parseQueryString(responseText);
    
    if (params['state'] === '1') {
      const mulNo = params['mul_no'];
      const payUrl = params['payurl'];
      
      updatePaymentStatus(rowIndex, 'PAYAPP_REQUESTED', mulNo, token);
      
      console.log('PayApp ê²°ì œ ìš”ì²­ ì„±ê³µ:', mulNo);
      
      return {
        success: true,
        payUrl: payUrl,
        mulNo: mulNo,
        message: 'PayApp ê²°ì œì°½ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.'
      };
    } else {
      const errorMessage = params['errorMessage'] || 'PayApp ê²°ì œ ìš”ì²­ ì‹¤íŒ¨';
      console.error('PayApp ìš”ì²­ ì‹¤íŒ¨:', errorMessage);
      
      updatePaymentStatus(rowIndex, 'FAILED', '', token);
      clearReservation(rowIndex);
      
      return {
        success: false,
        message: errorMessage
      };
    }
    
  } catch (error) {
    console.error('PayApp ìš”ì²­ ì˜¤ë¥˜:', error);
    updatePaymentStatus(rowIndex, 'FAILED', '', token);
    clearReservation(rowIndex);
    
    return {
      success: false,
      message: 'PayApp ì—°ë™ ì˜¤ë¥˜: ' + error.toString()
    };
  }
}

// ğŸ“ PayApp ì½œë°± ì²˜ë¦¬ (ğŸ”¥ ëª¨ë“  ê°€ëŠ¥ì„± ì²´í¬)
function handlePayAppCallback(data) {
  try {
    // ğŸ”¥ ëª¨ë“  ê°€ëŠ¥ì„±ì„ ì²´í¬í•˜ëŠ” ìŠˆí¼ ë””ë²„ê¹…
    const sheet = SpreadsheetApp.openById(CONFIG.SHEET_ID).getActiveSheet();
    
    console.log('=== PayApp ìŠˆí¼ ë””ë²„ê¹… ì‹œì‘ ===');
    console.log('ì „ì²´ ë°›ì€ ë°ì´í„°:', JSON.stringify(data, null, 2));
    console.log('ë°›ì€ ëª¨ë“  í‚¤:', Object.keys(data));
    
    // A500-A510ì— ëª¨ë“  ê°€ëŠ¥ì„± ê¸°ë¡
    const baseInfo = `${new Date()} | mul_no: ${data.mul_no}`;
    sheet.getRange('A500').setValue(baseInfo);
    
    // ğŸ”¥ ìƒíƒœ í•„ë“œ ê°€ëŠ¥ì„±ë“¤ ì²´í¬
    const statusFields = ['pay_state', 'status', 'state', 'result', 'payment_status', 'pay_result', 'transaction_status', 'paystate', 'payStatus'];
    let foundStatus = null;
    let statusValue = null;
    
    for (let field of statusFields) {
      if (data[field] !== undefined) {
        foundStatus = field;
        statusValue = data[field];
        console.log(`âœ… ìƒíƒœ í•„ë“œ ë°œê²¬: ${field} = ${statusValue}`);
        sheet.getRange('A501').setValue(`ìƒíƒœí•„ë“œ: ${field} = ${statusValue}`);
        break;
      }
    }
    
    if (!foundStatus) {
      console.log('âŒ ìƒíƒœ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
      sheet.getRange('A501').setValue('ìƒíƒœí•„ë“œ: ì—†ìŒ');
    }
    
    // ğŸ”¥ token/code í•„ë“œ ê°€ëŠ¥ì„±ë“¤ ì²´í¬
    const tokenFields = ['var1', 'token', 'custom1', 'param1', 'user_data1', 'merchant_data1', 'order_data1', 'userData1'];
    const codeFields = ['var2', 'code', 'custom2', 'param2', 'user_data2', 'merchant_data2', 'order_data2', 'userData2'];
    
    let foundToken = null;
    let tokenValue = null;
    let foundCode = null;
    let codeValue = null;
    
    for (let field of tokenFields) {
      if (data[field] !== undefined) {
        foundToken = field;
        tokenValue = data[field];
        console.log(`âœ… í† í° í•„ë“œ ë°œê²¬: ${field} = ${tokenValue}`);
        break;
      }
    }
    
    for (let field of codeFields) {
      if (data[field] !== undefined) {
        foundCode = field;
        codeValue = data[field];
        console.log(`âœ… ì½”ë“œ í•„ë“œ ë°œê²¬: ${field} = ${codeValue}`);
        break;
      }
    }
    
    sheet.getRange('A502').setValue(`í† í°: ${foundToken ? foundToken + '=' + tokenValue : 'ì—†ìŒ'}`);
    sheet.getRange('A503').setValue(`ì½”ë“œ: ${foundCode ? foundCode + '=' + codeValue : 'ì—†ìŒ'}`);
    
    // ğŸ”¥ ì„±ê³µ ìƒíƒœ ê°’ë“¤ ì²´í¬
    const successValues = ['4', 4, 'success', 'SUCCESS', 'complete', 'COMPLETE', 'paid', 'PAID', '1', 1, 'ok', 'OK', 'true', true];
    const isSuccess = statusValue && successValues.includes(statusValue);
    
    console.log(`ìƒíƒœê°’ ${statusValue}ê°€ ì„±ê³µì¸ê°€?`, isSuccess);
    sheet.getRange('A504').setValue(`ì„±ê³µì—¬ë¶€: ${isSuccess ? 'ì„±ê³µ' : 'ì‹¤íŒ¨/ì•Œìˆ˜ì—†ìŒ'} (ê°’: ${statusValue})`);
    
    // ğŸ”¥ ê¸°ë³¸ ê²€ì¦
    const userid = data.userid;
    const linkval = data.linkval;
    const mulNo = data.mul_no;
    
    if (!userid || !linkval || !mulNo) {
      console.error('í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½');
      sheet.getRange('A505').setValue(`í•„ìˆ˜íŒŒë¼ë¯¸í„°: ëˆ„ë½ (userid: ${!!userid}, linkval: ${!!linkval}, mulNo: ${!!mulNo})`);
      return 'FAIL';
    }
    
    if (userid !== CONFIG.PAYAPP_USERID) {
      console.error('userid ë¶ˆì¼ì¹˜');
      sheet.getRange('A505').setValue(`userid ë¶ˆì¼ì¹˜: ${userid} != ${CONFIG.PAYAPP_USERID}`);
      return 'FAIL';
    }
    
    sheet.getRange('A505').setValue('í•„ìˆ˜íŒŒë¼ë¯¸í„°: ëª¨ë‘ ì •ìƒ');
    
    // ğŸ”¥ mul_noë¡œ ê±°ë˜ ì°¾ê¸°
    const dataSheet = sheet.getDataRange().getValues();
    let targetRowIndex = -1;
    let targetBuyerEmail = '';
    let targetLicenseType = '';
    let matchedRow = null;
    
    for (let i = 1; i < dataSheet.length; i++) {
      const sheetMulNo = dataSheet[i][11];
      
      if (sheetMulNo === mulNo || String(sheetMulNo) === String(mulNo) || Number(sheetMulNo) === Number(mulNo)) {
        targetRowIndex = i + 1;
        targetBuyerEmail = dataSheet[i][7];
        targetLicenseType = dataSheet[i][1];
        
        matchedRow = {
          rowIndex: i + 1,
          code: dataSheet[i][0],
          licenseType: dataSheet[i][1],
          email: dataSheet[i][7],
          status: dataSheet[i][9],
          mulNo: dataSheet[i][11],
          token: dataSheet[i][12]
        };
        
        console.log('âœ… mul_no ë§¤ì¹­ ì„±ê³µ!', matchedRow);
        sheet.getRange('A506').setValue(`ë§¤ì¹­ì„±ê³µ: í–‰${i+1} ${dataSheet[i][7]}`);
        break;
      }
    }
    
    if (targetRowIndex === -1) {
      console.error('âŒ mul_no ë§¤ì¹­ ì‹¤íŒ¨:', mulNo);
      sheet.getRange('A506').setValue(`ë§¤ì¹­ì‹¤íŒ¨: mul_no ${mulNo} ëª»ì°¾ìŒ`);
      return 'SUCCESS';
    }
    
    // ğŸ”¥ ê²°ì œ ì²˜ë¦¬ ê²°ì •
    if (isSuccess) {
      console.log('ğŸ‰ ê²°ì œ ì„±ê³µìœ¼ë¡œ íŒë‹¨, PAID ì²˜ë¦¬ ì‹œì‘');
      sheet.getRange('A507').setValue('ê²°ì œì„±ê³µíŒë‹¨: PAID ì²˜ë¦¬ì¤‘');
      
      // PAID ìƒíƒœ ì—…ë°ì´íŠ¸
      sheet.getRange(targetRowIndex, 10).setValue('PAID');
      
      // ì´ë©”ì¼ ë°œì†¡
      try {
        const emailCode = codeValue || matchedRow.code;
        sendCodeEmail(emailCode, targetLicenseType, targetBuyerEmail);
        console.log('âœ… ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ');
        sheet.getRange('A508').setValue('ì´ë©”ì¼ë°œì†¡: ì™„ë£Œ');
      } catch (emailError) {
        console.error('âŒ ì´ë©”ì¼ ë°œì†¡ ì˜¤ë¥˜:', emailError);
        sheet.getRange('A508').setValue(`ì´ë©”ì¼ë°œì†¡: ì‹¤íŒ¨ ${emailError.toString()}`);
      }
      
      sheet.getRange('A509').setValue('ìµœì¢…ê²°ê³¼: ì„±ê³µì²˜ë¦¬ì™„ë£Œ');
      return 'SUCCESS';
      
    } else if (statusValue) {
      // ì‹¤íŒ¨ ìƒíƒœë“¤
      const failValues = ['8', '16', '32', '9', '64', '70', '71', 'cancel', 'fail', 'error', 'CANCEL', 'FAIL', 'ERROR', 'false', false, '0', 0];
      const isFail = failValues.includes(statusValue);
      
      if (isFail) {
        console.log('âŒ ê²°ì œ ì‹¤íŒ¨ë¡œ íŒë‹¨');
        sheet.getRange('A507').setValue('ê²°ì œì‹¤íŒ¨íŒë‹¨: FAILED ì²˜ë¦¬ì¤‘');
        sheet.getRange(targetRowIndex, 10).setValue('FAILED');
        clearReservation(targetRowIndex);
        sheet.getRange('A509').setValue('ìµœì¢…ê²°ê³¼: ì‹¤íŒ¨ì²˜ë¦¬ì™„ë£Œ');
        return 'SUCCESS';
      } else {
        console.log('âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ:', statusValue);
        sheet.getRange('A507').setValue(`ì•Œìˆ˜ì—†ëŠ”ìƒíƒœ: ${statusValue}`);
        sheet.getRange('A509').setValue('ìµœì¢…ê²°ê³¼: ëŒ€ê¸°ìƒíƒœìœ ì§€');
        return 'SUCCESS';
      }
    } else {
      console.log('âš ï¸ ìƒíƒœ ê°’ì´ ì—†ìŒ');
      sheet.getRange('A507').setValue('ìƒíƒœê°’ì—†ìŒ: íŒë‹¨ë¶ˆê°€');
      sheet.getRange('A509').setValue('ìµœì¢…ê²°ê³¼: ìƒíƒœë¯¸í™•ì¸');
      return 'SUCCESS';
    }
    
  } catch (error) {
    console.error('âŒ ì½œë°± ì²˜ë¦¬ ì¹˜ëª…ì  ì˜¤ë¥˜:', error);
    try {
      const sheet = SpreadsheetApp.openById(CONFIG.SHEET_ID).getActiveSheet();
      sheet.getRange('A510').setValue(`ì¹˜ëª…ì ì˜¤ë¥˜: ${error.toString()}`);
    } catch (logError) {
      // ë¡œê·¸ ì˜¤ë¥˜ë„ ë¬´ì‹œ
    }
    return 'SUCCESS';
  }
}

// ğŸ”„ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
function updatePaymentStatus(rowIndex, status, mulNo, token) {
  try {
    const sheet = SpreadsheetApp.openById(CONFIG.SHEET_ID).getActiveSheet();
    sheet.getRange(rowIndex, 10).setValue(status);      // Jì—´(9ë²ˆ ì¸ë±ìŠ¤) = status  
    if (mulNo) sheet.getRange(rowIndex, 11).setValue(mulNo);  // Kì—´(10ë²ˆ ì¸ë±ìŠ¤) = mul_no
    if (token) sheet.getRange(rowIndex, 12).setValue(token);  // Lì—´(11ë²ˆ ì¸ë±ìŠ¤) = token
  } catch (error) {
    console.error('ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
  }
}

function clearReservation(rowIndex) {
  try {
    const sheet = SpreadsheetApp.openById(CONFIG.SHEET_ID).getActiveSheet();
    sheet.getRange(rowIndex, 9).setValue('');   // Iì—´(ì´ë©”ì¼) í´ë¦¬ì–´
    sheet.getRange(rowIndex, 10).setValue('');  // Jì—´(ìƒíƒœ/ë‚ ì§œ) í´ë¦¬ì–´
    sheet.getRange(rowIndex, 11).setValue('');  // Kì—´(mul_no) í´ë¦¬ì–´  
    sheet.getRange(rowIndex, 12).setValue('');  // Lì—´(token) í´ë¦¬ì–´
  } catch (error) {
    console.error('ì˜ˆì•½ í•´ì œ ì˜¤ë¥˜:', error);
  }
}

// ğŸ“§ ì´ë©”ì¼ ë°œì†¡
function sendCodeEmail(code, licenseType, buyerEmail) {
  try {
    const subject = '[LittleScienceAI] ' + licenseType + ' ë°œê¸‰ ì™„ë£Œ';
    
    const textBody = 'ì•ˆë…•í•˜ì„¸ìš”! LittleScienceAIë¥¼ êµ¬ë§¤í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.\n\n' +
                     'ì´ìš©ê¶Œ ì½”ë“œ: ' + code + '\n' +
                     'ì´ìš©ê¸°ê°„: ' + licenseType + '\n' +
                     'ì ‘ì† ë§í¬: https://little-science-ai-918631854597.asia-northeast3.run.app/\n\n' +
                     'ì´ìš© ë°©ë²•:\n' +
                     '1. ìœ„ ë§í¬ë¡œ ì ‘ì†\n' +
                     '2. ì¸ì¦ í‚¤ì— ì½”ë“œ ì…ë ¥\n' +
                     '3. ê³¼í•™ ë…¼ë¬¸ íƒìƒ‰ ì‹œì‘!\n\n' +
                     'ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ì—°ë½ì£¼ì„¸ìš”.\n\n' +
                     'ê°ì‚¬í•©ë‹ˆë‹¤.\n' +
                     'LittleScienceAI íŒ€';
    
    const htmlBody = '<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>LittleScienceAI ì´ìš©ê¶Œ ë°œê¸‰</title></head><body style="margin: 0; padding: 0; font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; line-height: 1.6;"><div style="max-width: 600px; margin: 20px auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"><div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px 20px; text-align: center; color: white;"><h1 style="margin: 0; font-size: 28px; font-weight: bold;">LittleScienceAI</h1><p style="margin: 10px 0 0 0; font-size: 16px; opacity: 0.9;">ê³¼í•™ë…¼ë¬¸ ì£¼ì œ íƒìƒ‰ ë„ìš°ë¯¸</p></div><div style="padding: 30px 20px;"><div style="text-align: center; margin-bottom: 30px;"><h2 style="color: #333; margin: 0 0 10px 0; font-size: 24px;">ì´ìš©ê¶Œ ë°œê¸‰ ì™„ë£Œ</h2><p style="color: #666; margin: 0; font-size: 16px;">êµ¬ë§¤í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!</p></div><div style="background: #f8f9ff; border: 2px solid #667eea; border-radius: 12px; padding: 25px; margin: 20px 0; text-align: center;"><div style="color: #667eea; font-size: 18px; font-weight: bold; margin-bottom: 15px;">' + licenseType + '</div><div style="background: white; border: 2px dashed #667eea; border-radius: 8px; padding: 20px; margin: 15px 0;"><p style="color: #333; margin: 0 0 10px 0; font-size: 14px; font-weight: bold;">ì´ìš©ê¶Œ ì½”ë“œ</p><div style="font-size: 24px; font-weight: bold; color: #667eea; letter-spacing: 2px; font-family: \'Courier New\', monospace; user-select: all; -webkit-user-select: all; -moz-user-select: all; -ms-user-select: all; cursor: text; padding: 10px; background: #f8f9ff; border-radius: 6px;">' + code + '</div><p style="color: #888; margin: 10px 0 0 0; font-size: 12px;">ìœ„ ì½”ë“œë¥¼ ë§ˆìš°ìŠ¤ë¡œ ì„ íƒí•˜ì—¬ ë³µì‚¬í•˜ì„¸ìš”</p></div></div><div style="background: #e8f5e8; border: 1px solid #28a745; border-radius: 12px; padding: 25px; margin: 20px 0;"><h3 style="color: #28a745; margin: 0 0 15px 0; font-size: 18px;">ì´ìš© ë°©ë²•</h3><ol style="color: #333; margin: 0; padding-left: 20px;"><li style="margin-bottom: 8px;">ì•„ë˜ ë§í¬ë¡œ ì ‘ì†í•˜ì„¸ìš”</li><li style="margin-bottom: 8px;">ì¸ì¦ í‚¤ ì…ë ¥ë€ì— ìœ„ì˜ ì´ìš©ê¶Œ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</li><li style="margin-bottom: 8px;">ê³¼í•™ ë…¼ë¬¸ íƒìƒ‰ì„ ì‹œì‘í•˜ì„¸ìš”!</li></ol></div><div style="text-align: center; margin: 30px 0;"><a href="https://little-science-ai-918631854597.asia-northeast3.run.app/" style="display: inline-block; background: linear-gradient(45deg, #28a745, #20c997); color: white; text-decoration: none; padding: 15px 30px; border-radius: 25px; font-weight: bold; font-size: 16px; box-shadow: 0 4px 12px rgba(40,167,69,0.3);">LittleScienceAI ì ‘ì†í•˜ê¸°</a></div><div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 20px 0;"><p style="color: #856404; margin: 0; font-size: 14px; text-align: center;"><strong>ì´ìš©ê¶Œ ìœ íš¨ê¸°ê°„:</strong> ì½”ë“œ ì…ë ¥ í›„ ' + licenseType.replace('ì´ìš©ê¶Œ', '') + ' ë™ì•ˆ ì´ìš© ê°€ëŠ¥</p></div></div><div style="background: #f8f9fa; padding: 20px; text-align: center; border-top: 1px solid #e9ecef;"><p style="color: #666; margin: 0 0 10px 0; font-size: 14px;">ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ì—°ë½ì£¼ì„¸ìš”</p><div style="margin: 15px 0;"><span style="background: #667eea; color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">ì¹´ì¹´ì˜¤í†¡ ì±„ë„: ë¦¬í‹€ì‚¬ì´ì–¸ìŠ¤AI</span></div><p style="color: #999; margin: 15px 0 0 0; font-size: 12px;">LittleScienceAI íŒ€<br>ì´ ì´ë©”ì¼ì€ ìë™ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p></div></div></body></html>';
    
    GmailApp.sendEmail(
      buyerEmail, 
      subject, 
      textBody,
      {
        htmlBody: htmlBody
      }
    );
    
    console.log('HTML ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ:', buyerEmail);
    
  } catch (error) {
    console.error('ì´ë©”ì¼ ë°œì†¡ ì˜¤ë¥˜:', error);
  }
}

// ğŸ¨ HTML í˜ì´ì§€ ìƒì„±
function createRedirectPage(payUrl, mulNo) {
  return '<!DOCTYPE html><html><head><title>PayApp ê²°ì œì°½ ì´ë™</title><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>body { font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center; } .redirect { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); display: inline-block; max-width: 500px; } h1 { color: #333; margin-bottom: 20px; } p { color: #666; margin: 10px 0; } .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style><script>setTimeout(() => { window.location.href = \'' + payUrl + '\'; }, 1000);</script></head><body><div class="redirect"><h1>ğŸ”„ PayApp ê²°ì œì°½ ì´ë™</h1><div class="spinner"></div><p>PayApp ê²°ì œì°½ìœ¼ë¡œ ì´ë™ ì¤‘ì…ë‹ˆë‹¤...</p><p><small>ê²°ì œ ë²ˆí˜¸: ' + mulNo + '</small></p></div></body></html>';
}

// ğŸ”¥ ì—ëŸ¬ í˜ì´ì§€ HTML ìƒì„± í•¨ìˆ˜ (ì‘ë‹µ í˜•ì‹ í†µì¼)
function createErrorPageHtml(message) {
  return '<!DOCTYPE html><html><head><title>ì˜¤ë¥˜</title><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>body { font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 50px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center; } .error { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); display: inline-block; max-width: 500px; } h1 { color: #e74c3c; margin-bottom: 20px; } p { color: #666; margin: 10px 0; } .close-btn { background: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-top: 20px; font-size: 16px; }</style></head><body><div class="error"><h1>âŒ ì˜¤ë¥˜</h1><p><strong>' + message + '</strong></p><button class="close-btn" onclick="window.close()">ì°½ ë‹«ê¸°</button></div></body></html>';
}

// ê¸°ì¡´ createErrorPage í•¨ìˆ˜ (í•˜ìœ„ í˜¸í™˜ì„±)
function createErrorPage(message) {
  return HtmlService.createHtmlOutput(createErrorPageHtml(message));
}

// ğŸ” ê´€ë¦¬ì í•¨ìˆ˜ë“¤
function getCurrentUrl() {
  const devUrl = ScriptApp.getService().getUrl();
  const prodUrl = CONFIG.FEEDBACK_URL;
  
  console.log('ê°œë°œ ëª¨ë“œ URL:', devUrl);
  console.log('ì‹¤ì œ ë°°í¬ URL:', prodUrl);
  console.log('PayApp FeedbackURLì— ì„¤ì •í•  URL:', prodUrl);
  
  return {
    dev: devUrl,
    production: prodUrl,
    useForPayApp: prodUrl
  };
}

function testPurchase() {
  console.log('=== êµ¬ë§¤ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
  const result = purchaseLicense("7ì¼ ì´ìš©ê¶Œ", "test@email.com");
  console.log('í…ŒìŠ¤íŠ¸ ê²°ê³¼:', result);
  console.log('=== êµ¬ë§¤ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
  return result;
}

function checkStock() {
  try {
    const sheet = SpreadsheetApp.openById(CONFIG.SHEET_ID).getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    const stock = {
      '7ì¼ ì´ìš©ê¶Œ': 0,
      '15ì¼ ì´ìš©ê¶Œ': 0,
      '30ì¼ ì´ìš©ê¶Œ': 0
    };
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][4] === '' && (!data[i][9] || data[i][9] === '')) {
        const type = data[i][1];
        if (stock.hasOwnProperty(type)) {
          stock[type]++;
        }
      }
    }
    
    console.log('ğŸ“¦ í˜„ì¬ ì¬ê³  í˜„í™©:', stock);
    return stock;
    
  } catch (error) {
    console.error('ì¬ê³  í™•ì¸ ì˜¤ë¥˜:', error);
    return null;
  }
}

// ğŸ§ª === í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤ ===

function testEmailSending() {
  console.log('=== ì´ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
  
  try {
    console.log('í•˜ë“œì½”ë”© ê°’ìœ¼ë¡œ ì´ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸');
    sendCodeEmail('TEST-CODE-123', '7ì¼ ì´ìš©ê¶Œ', 'test@gmail.com');
    console.log('âœ… ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ');
  } catch (error) {
    console.error('âŒ ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨:', error);
  }
  
  console.log('=== ì´ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
}

function testSpreadsheetSearch() {
  console.log('=== ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
  
  try {
    const sheet = SpreadsheetApp.openById(CONFIG.SHEET_ID).getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    console.log('ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì „ì²´ í–‰ ìˆ˜:', data.length);
    console.log('í—¤ë”:', data[0]);
    
    const statusCount = {};
    for (let i = 1; i < data.length; i++) {
      const status = data[i][9] || 'EMPTY';
      statusCount[status] = (statusCount[status] || 0) + 1;
    }
    console.log('ìƒíƒœë³„ ë°ì´í„° ê°œìˆ˜:', statusCount);
    
    console.log('=== PAYAPP_REQUESTED ìƒíƒœ ë°ì´í„°ë“¤ ===');
    for (let i = 1; i < data.length; i++) {
      if (data[i][9] === 'PAYAPP_REQUESTED') {
        console.log(`í–‰ ${i+1}:`, {
          code: data[i][0],
          licenseType: data[i][1],
          email: data[i][7],
          mulNo: data[i][11],
          token: data[i][12]
        });
      }
    }
    
  } catch (error) {
    console.error('âŒ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
  }
  
  console.log('=== ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
}
