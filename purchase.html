// ğŸš€ LittleScienceAI + PayApp ìë™ êµ¬ë§¤ ì‹œìŠ¤í…œ ë°±ì—”ë“œ (ì™„ì „ ë²„ì „ - X-Frame-Options ë¬¸ì œ í•´ê²° + ë¡œê·¸ ì‹œìŠ¤í…œ)

// ğŸ”§ ì„¤ì •ê°’ë“¤
const CONFIG = {
  SHEET_ID: '1ogVkRidiKcL2fcn9DTgPFlCp-nehjDZMRhx7EJqKIr0',
  PAYAPP_USERID: 'kstore101',
  PAYAPP_LINKKEY: 'CCiZIswPVKh+xt+QKt/+b+1DPJnCCRVaOgT+oqg6zaM=',
  PAYAPP_LINKVAL: 'CCiZIswPVKh+xt+QKt/+bxTdEGsBOXZ7gUSUjzGppZM=',
  FEEDBACK_URL: 'https://script.google.com/macros/s/AKfycbzDBLmB1rDBJVCuP3FXGdZEvuougqgcgKu-GzSXaq1c2DDFec_lrcSUyuWckmzFoeT8/exec'
};

const PRICE_MAP = {
  '7ì¼ ì´ìš©ê¶Œ': 9900,
  '15ì¼ ì´ìš©ê¶Œ': 14900,
  '30ì¼ ì´ìš©ê¶Œ': 18900
};

// ğŸ“ ë¡œê·¸ ê¸°ë¡ í•¨ìˆ˜ (ìƒˆë¡œ ì¶”ê°€)
function writeLog(logType, message, data = null) {
  try {
    const sheet = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    let logSheet;
    
    try {
      logSheet = sheet.getSheetByName('PayApp_ë¡œê·¸');
    } catch (e) {
      // ë¡œê·¸ ì‹œíŠ¸ê°€ ì—†ìœ¼ë©´ ìƒì„±
      logSheet = sheet.insertSheet('PayApp_ë¡œê·¸');
      // í—¤ë” ì¶”ê°€
      logSheet.getRange(1, 1, 1, 5).setValues([['ì‹œê°„', 'íƒ€ì…', 'ë©”ì‹œì§€', 'ë°ì´í„°', 'IP/ê¸°íƒ€']]);
      logSheet.getRange(1, 1, 1, 5).setFontWeight('bold');
    }
    
    const now = new Date();
    const timeString = Utilities.formatDate(now, 'Asia/Seoul', 'yyyy-MM-dd HH:mm:ss');
    const dataString = data ? JSON.stringify(data) : '';
    
    logSheet.appendRow([timeString, logType, message, dataString, '']);
    
    // ë¡œê·¸ê°€ 1000ì¤„ ë„˜ìœ¼ë©´ ì˜¤ë˜ëœ ê²ƒ ì‚­ì œ
    const lastRow = logSheet.getLastRow();
    if (lastRow > 1000) {
      logSheet.deleteRows(2, lastRow - 1000);
    }
    
  } catch (error) {
    console.error('ë¡œê·¸ ê¸°ë¡ ì˜¤ë¥˜:', error);
  }
}

// ğŸ”§ URL íŒŒë¼ë¯¸í„° íŒŒì‹± í•¨ìˆ˜
function parseQueryString(queryString) {
  const params = {};
  if (!queryString) return params;
  
  const pairs = queryString.split('&');
  for (let i = 0; i < pairs.length; i++) {
    const pair = pairs[i].split('=');
    if (pair.length === 2) {
      const key = decodeURIComponent(pair[0]);
      const value = decodeURIComponent(pair[1]);
      params[key] = value;
    }
  }
  return params;
}

// ğŸ”— FeedbackURL ë°˜í™˜
function getFeedbackUrl() {
  return CONFIG.FEEDBACK_URL;
}

// ğŸ“ ë©”ì¸ POST ì²˜ë¦¬ í•¨ìˆ˜
function doPost(e) {
  try {
    // ğŸ” ëª¨ë“  POST ìš”ì²­ ë¡œê·¸ ê¸°ë¡
    writeLog('POST_REQUEST', 'doPost í•¨ìˆ˜ ì‹œì‘', {
      postData: e.postData ? e.postData.contents : 'NO_POST_DATA',
      parameter: e.parameter,
      headers: e.headers || {}
    });
    
    let data;
    
    if (e.postData && e.postData.contents) {
      try {
        data = JSON.parse(e.postData.contents);
        writeLog('POST_PARSE', 'JSON íŒŒì‹± ì„±ê³µ', data);
      } catch (jsonError) {
        data = e.parameter;
        writeLog('POST_PARSE', 'JSON íŒŒì‹± ì‹¤íŒ¨, parameter ì‚¬ìš©', data);
      }
    } else {
      data = e.parameter;
      writeLog('POST_PARSE', 'postData ì—†ìŒ, parameter ì‚¬ìš©', data);
    }
    
    console.log('ë°›ì€ ë°ì´í„°:', data);
    
    // PayApp ì½œë°± ì²˜ë¦¬
    if (data.userid && data.linkval && data.mul_no) {
      writeLog('PAYAPP_CALLBACK', 'PayApp ì½œë°± ê°ì§€', {
        userid: data.userid,
        mul_no: data.mul_no,
        pay_state: data.pay_state,
        var1: data.var1,
        var2: data.var2
      });
      
      const result = handlePayAppCallback(data);
      
      writeLog('PAYAPP_RESULT', 'PayApp ì½œë°± ì²˜ë¦¬ ì™„ë£Œ', { result: result });
      
      return ContentService.createTextOutput(result).setMimeType(ContentService.MimeType.TEXT);
    }
    
    // êµ¬ë§¤ ìš”ì²­ ì²˜ë¦¬
    if (data.action === 'purchase') {
      writeLog('PURCHASE_REQUEST', 'êµ¬ë§¤ ìš”ì²­ ì²˜ë¦¬ ì‹œì‘', {
        licenseType: data.licenseType,
        buyerEmail: data.buyerEmail,
        buyerPhone: data.buyerPhone
      });
      
      const reservationResult = purchaseLicense(data.licenseType, data.buyerEmail);
      
      if (reservationResult.success) {
        const payAppResult = requestPayAppPayment(
          data.licenseType, 
          data.buyerEmail,
          data.buyerPhone,
          reservationResult.code, 
          reservationResult.token,
          reservationResult.rowIndex
        );
        
        if (payAppResult.success) {
          const html = createRedirectPage(payAppResult.payUrl, payAppResult.mulNo);
          return HtmlService.createHtmlOutput(html);
        } else {
          return createErrorPage(payAppResult.message);
        }
      } else {
        return createErrorPage(reservationResult.message);
      }
    }
    
    writeLog('UNKNOWN_REQUEST', 'ì•Œ ìˆ˜ ì—†ëŠ” ìš”ì²­', data);
    return createErrorPage('ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤.');
      
  } catch (error) {
    writeLog('ERROR', 'doPost ì—ëŸ¬ ë°œìƒ', { error: error.toString(), stack: error.stack });
    console.error('doPost ì—ëŸ¬:', error);
    return createErrorPage('ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.toString());
  }
}

// ğŸ“ GET ìš”ì²­ ì²˜ë¦¬ í•¨ìˆ˜ (ë””ë²„ê¹…ìš©)
function doGet(e) {
  writeLog('GET_REQUEST', 'GET ìš”ì²­ ë°›ìŒ - ë²„ì „ 40', e.parameter);
  console.log('GET ìš”ì²­ ë°›ìŒ - ë²„ì „ 40:', e.parameter);
  
  // í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë°˜í™˜
  const html = '<!DOCTYPE html><html><head><title>LittleScienceAI ë°±ì—”ë“œ v40</title><meta charset="UTF-8"></head><body><h1>ğŸ§ª LittleScienceAI ë°±ì—”ë“œ v40</h1><p>ë°±ì—”ë“œê°€ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤!</p><p><strong>ì£¼ì˜:</strong> ì´ í˜ì´ì§€ëŠ” GET ìš”ì²­ ê²°ê³¼ì…ë‹ˆë‹¤.</p><p>êµ¬ë§¤ëŠ” í”„ë¡ íŠ¸ì—”ë“œ HTML í˜ì´ì§€ì—ì„œ POST ìš”ì²­ìœ¼ë¡œ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤.</p><hr><h3>ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ</h3><ul><li>âœ… Google Apps Script ì‘ë™ (v40)</li><li>âœ… ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì—°ê²°</li><li>âœ… PayApp ì„¤ì • ì™„ë£Œ</li><li>âœ… ì‹¤ì‹œê°„ ë¡œê·¸ ì‹œìŠ¤í…œ í™œì„±í™”</li></ul><h3>ğŸ”— FeedbackURL</h3><p><code>https://script.google.com/macros/s/AKfycbzDBLmB1rDBJVCuP3FXGdZEvuougqgcgKu-GzSXaq1c2DDFec_lrcSUyuWckmzFoeT8/exec</code></p></body></html>';
  
  return HtmlService.createHtmlOutput(html);
}

// ğŸ« ë¼ì´ì„¼ìŠ¤ êµ¬ë§¤ ì˜ˆì•½
function purchaseLicense(licenseType, buyerEmail) {
  try {
    const sheet = SpreadsheetApp.openById(CONFIG.SHEET_ID).getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    console.log('êµ¬ë§¤ ìš”ì²­:', licenseType, buyerEmail);
    
    // ì§„í–‰ ì¤‘ì¸ ê±°ë˜ ì¤‘ë³µ ì²´í¬ (1ë¶„ ë‚´)
    const oneMinuteAgo = new Date(Date.now() - 1 * 60 * 1000);
    for (let i = 1; i < data.length; i++) {
      if (data[i][7] === buyerEmail && 
          (data[i][9] === 'PENDING' || data[i][9] === 'PAYAPP_REQUESTED')) {
        
        if (data[i][8] && new Date(data[i][8]) > oneMinuteAgo) {
          return {
            success: false,
            message: 'ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì¸ ê²°ì œê°€ ìˆìŠµë‹ˆë‹¤. 1ë¶„ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
          };
        }
      }
    }
    
    // ì¬ê³  ì°¾ê¸° ë° ì˜ˆì•½
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === licenseType && data[i][4] === '' && 
          (!data[i][9] || data[i][9] === '')) {
        
        console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ì½”ë“œ ë°œê²¬:', data[i][0]);
        
        const uniqueToken = Utilities.getUuid();
        updatePaymentStatus(i + 1, 'PENDING', '', uniqueToken);
        
        sheet.getRange(i + 1, 8).setValue(buyerEmail);
        sheet.getRange(i + 1, 9).setValue(new Date());
        
        const code = data[i][0];
        
        console.log('ì˜ˆì•½ ì™„ë£Œ:', code, 'â†’', buyerEmail, '(í† í°:', uniqueToken, ')');
        
        return {
          success: true,
          code: code,
          token: uniqueToken,
          message: 'ì˜ˆì•½ ì™„ë£Œ. PayApp ê²°ì œë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”.',
          rowIndex: i + 1
        };
      }
    }
    
    console.log('ì¬ê³  ë¶€ì¡±:', licenseType);
    return {
      success: false,
      message: licenseType + ' ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.'
    };
    
  } catch (error) {
    console.error('êµ¬ë§¤ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    return {
      success: false,
      message: 'ì‹œìŠ¤í…œ ì˜¤ë¥˜: ' + error.toString()
    };
  }
}

// ğŸ’³ PayApp ê²°ì œ ìš”ì²­
function requestPayAppPayment(licenseType, buyerEmail, buyerPhone, code, token, rowIndex) {
  try {
    updatePaymentStatus(rowIndex, 'PAYAPP_REQUESTED', '', token);
    
    const price = PRICE_MAP[licenseType];
    
    const payload = {
      'cmd': 'payrequest',
      'userid': CONFIG.PAYAPP_USERID,
      'goodname': 'LittleScienceAI ' + licenseType,
      'price': price.toString(),
      'recvphone': buyerPhone,
      'memo': 'LittleScienceAI ' + licenseType + ' êµ¬ë§¤ (' + buyerEmail + ')',
      'feedbackurl': getFeedbackUrl(),
      'returnurl': 'data:text/html,<script>alert("ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"); window.close();</script>',
      'var1': token,
      'var2': code,
      'checkretry': 'y',
      'smsuse': 'n'
    };
    
    console.log('PayApp ìš”ì²­ ë°ì´í„°:', payload);
    
    const response = UrlFetchApp.fetch('https://api.payapp.kr/oapi/apiLoad.html', {
      'method': 'POST',
      'payload': payload,
      'muteHttpExceptions': true
    });
    
    const responseText = response.getContentText();
    console.log('PayApp ì‘ë‹µ:', responseText);
    
    const params = parseQueryString(responseText);
    
    if (params['state'] === '1') {
      const mulNo = params['mul_no'];
      const payUrl = params['payurl'];
      
      updatePaymentStatus(rowIndex, 'PAYAPP_REQUESTED', mulNo, token);
      
      console.log('PayApp ê²°ì œ ìš”ì²­ ì„±ê³µ:', mulNo);
      
      return {
        success: true,
        payUrl: payUrl,
        mulNo: mulNo,
        message: 'PayApp ê²°ì œì°½ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.'
      };
    } else {
      const errorMessage = params['errorMessage'] || 'PayApp ê²°ì œ ìš”ì²­ ì‹¤íŒ¨';
      console.error('PayApp ìš”ì²­ ì‹¤íŒ¨:', errorMessage);
      
      updatePaymentStatus(rowIndex, 'FAILED', '', token);
      clearReservation(rowIndex);
      
      return {
        success: false,
        message: errorMessage
      };
    }
    
  } catch (error) {
    console.error('PayApp ìš”ì²­ ì˜¤ë¥˜:', error);
    updatePaymentStatus(rowIndex, 'FAILED', '', token);
    clearReservation(rowIndex);
    
    return {
      success: false,
      message: 'PayApp ì—°ë™ ì˜¤ë¥˜: ' + error.toString()
    };
  }
}

// ğŸ“ PayApp ì½œë°± ì²˜ë¦¬
function handlePayAppCallback(data) {
  try {
    writeLog('CALLBACK_START', 'ğŸ“ PayApp ì½œë°± ì‹œì‘ - ë²„ì „ 40', data);
    console.log('ğŸ“ PayApp ì½œë°± ì‹œì‘ - ë²„ì „ 40:', JSON.stringify(data));
    
    const userid = data.userid;
    const linkval = data.linkval;
    const mulNo = data.mul_no;
    const payState = data.pay_state;
    const token = data.var1;
    const code = data.var2;
    
    const parsedData = {
      userid: userid,
      linkval: linkval ? 'OK' : 'MISSING',
      mulNo: mulNo,
      payState: payState,
      token: token,
      code: code
    };
    
    writeLog('CALLBACK_PARSE', 'ì½œë°± íŒŒë¼ë¯¸í„° í™•ì¸', parsedData);
    console.log('ì½œë°± íŒŒë¼ë¯¸í„° í™•ì¸:', parsedData);
    
    if (!userid || !linkval || !mulNo) {
      writeLog('CALLBACK_ERROR', 'âŒ í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½', { userid, linkval, mulNo });
      console.error('âŒ í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½:', { userid, linkval, mulNo });
      return 'FAIL';
    }
    
    if (userid !== CONFIG.PAYAPP_USERID) {
      writeLog('CALLBACK_ERROR', 'âŒ userid ë¶ˆì¼ì¹˜', { received: userid, expected: CONFIG.PAYAPP_USERID });
      console.error('âŒ userid ë¶ˆì¼ì¹˜:', userid, 'â‰ ', CONFIG.PAYAPP_USERID);
      return 'FAIL';
    }
    
    if (linkval !== CONFIG.PAYAPP_LINKVAL) {
      writeLog('CALLBACK_ERROR', 'âŒ linkval ë¶ˆì¼ì¹˜', { received: 'HIDDEN', expected: 'CONFIGURED' });
      console.error('âŒ linkval ë¶ˆì¼ì¹˜');
      return 'FAIL';
    }
    
    if (isCallbackAlreadyProcessed(token, mulNo)) {
      writeLog('CALLBACK_SKIP', 'âš ï¸ ì´ë¯¸ ì²˜ë¦¬ëœ ì½œë°±', { token, mulNo });
      console.log('âš ï¸ ì´ë¯¸ ì²˜ë¦¬ëœ ì½œë°±:', token, mulNo);
      return 'SUCCESS';
    }
    
    recordCallbackProcessed(token, mulNo);
    writeLog('CALLBACK_CACHE', 'ì½œë°± ì²˜ë¦¬ ê¸°ë¡ ì €ì¥', { token, mulNo });
    
    const sheet = SpreadsheetApp.openById(CONFIG.SHEET_ID).getActiveSheet();
    const dataSheet = sheet.getDataRange().getValues();
    
    let targetRowIndex = -1;
    let targetBuyerEmail = '';
    let targetLicenseType = '';
    
    writeLog('CALLBACK_SEARCH', 'ğŸ” ê±°ë˜ ì •ë³´ ê²€ìƒ‰ ì¤‘', { token, code, totalRows: dataSheet.length });
    console.log('ğŸ” ê±°ë˜ ì •ë³´ ê²€ìƒ‰ ì¤‘:', { token, code });
    
    for (let i = 1; i < dataSheet.length; i++) {
      if (dataSheet[i][11] === token && dataSheet[i][0] === code) {
        targetRowIndex = i + 1;
        targetBuyerEmail = dataSheet[i][7];
        targetLicenseType = dataSheet[i][1];
        
        writeLog('CALLBACK_FOUND', 'âœ… ê±°ë˜ ì •ë³´ ë°œê²¬', {
          row: targetRowIndex,
          email: targetBuyerEmail,
          license: targetLicenseType,
          currentStatus: dataSheet[i][9]
        });
        
        console.log('âœ… ê±°ë˜ ì •ë³´ ë°œê²¬:', {
          row: targetRowIndex,
          email: targetBuyerEmail,
          license: targetLicenseType
        });
        break;
      }
    }
    
    if (targetRowIndex === -1) {
      writeLog('CALLBACK_NOT_FOUND', 'âŒ í•´ë‹¹ ê±°ë˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', { token, code });
      console.error('âŒ í•´ë‹¹ ê±°ë˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', { token, code });
      
      // ìµœê·¼ ëª‡ ê°œ í–‰ ë¡œê·¸ë¡œ ê¸°ë¡
      const recentData = [];
      for (let i = Math.max(1, dataSheet.length - 5); i < dataSheet.length; i++) {
        if (dataSheet[i][0]) {
          recentData.push({
            row: i + 1,
            code: dataSheet[i][0],
            token: dataSheet[i][11],
            email: dataSheet[i][7]
          });
        }
      }
      writeLog('CALLBACK_DEBUG', 'ğŸ“‹ ìµœê·¼ ì‹œíŠ¸ ë°ì´í„°', recentData);
      
      console.log('ğŸ“‹ í˜„ì¬ ì‹œíŠ¸ ë°ì´í„° í™•ì¸ ì¤‘...');
      for (let i = 1; i < Math.min(dataSheet.length, 10); i++) {
        console.log(`í–‰ ${i + 1}:`, {
          code: dataSheet[i][0],
          token: dataSheet[i][11],
          email: dataSheet[i][7]
        });
      }
      return 'SUCCESS';
    }
    
    if (payState === '4') {
      writeLog('CALLBACK_PAYMENT_SUCCESS', 'ğŸ’³ ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ ì‹œì‘', { 
        code, 
        email: targetBuyerEmail, 
        license: targetLicenseType,
        mulNo: mulNo
      });
      console.log('ğŸ’³ ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ ì‹œì‘:', { code, email: targetBuyerEmail });
      
      updatePaymentStatus(targetRowIndex, 'PAID', mulNo, token);
      writeLog('CALLBACK_STATUS_UPDATE', 'âœ… ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ', { 
        row: targetRowIndex, 
        status: 'PAID' 
      });
      console.log('âœ… ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
      
      try {
        writeLog('CALLBACK_EMAIL_START', 'ğŸ“§ ì´ë©”ì¼ ë°œì†¡ ì‹œì‘', { email: targetBuyerEmail });
        console.log('ğŸ“§ ì´ë©”ì¼ ë°œì†¡ ì‹œì‘:', targetBuyerEmail);
        
        sendCodeEmail(code, targetLicenseType, targetBuyerEmail);
        
        writeLog('CALLBACK_EMAIL_SUCCESS', 'âœ… ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ', { 
          email: targetBuyerEmail,
          code: code,
          license: targetLicenseType
        });
        console.log('âœ… ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ');
        
      } catch (emailError) {
        writeLog('CALLBACK_EMAIL_ERROR', 'âŒ ì´ë©”ì¼ ë°œì†¡ ì˜¤ë¥˜', { 
          error: emailError.toString(),
          email: targetBuyerEmail 
        });
        console.error('âŒ ì´ë©”ì¼ ë°œì†¡ ì˜¤ë¥˜:', emailError.toString());
        // ì´ë©”ì¼ ì‹¤íŒ¨í•´ë„ ê²°ì œëŠ” ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
      }
      
      writeLog('CALLBACK_COMPLETE', 'ğŸ‰ ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ ì„±ê³µ', { 
        code, 
        email: targetBuyerEmail 
      });
      console.log('ğŸ‰ ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ ì„±ê³µ:', code, 'â†’', targetBuyerEmail);
      return 'SUCCESS';
      
    } else if (payState === '8' || payState === '16' || payState === '32' || 
               payState === '9' || payState === '64' || payState === '70' || payState === '71') {
      
      writeLog('CALLBACK_PAYMENT_CANCEL', 'ğŸš« ê²°ì œ ì·¨ì†Œ/ì‹¤íŒ¨ ì²˜ë¦¬', { 
        code, 
        payState,
        email: targetBuyerEmail 
      });
      console.log('ğŸš« ê²°ì œ ì·¨ì†Œ/ì‹¤íŒ¨ ì²˜ë¦¬:', { code, payState });
      
      updatePaymentStatus(targetRowIndex, 'FAILED', mulNo, token);
      clearReservation(targetRowIndex);
      
      writeLog('CALLBACK_CANCEL_COMPLETE', 'âœ… ì·¨ì†Œ ì²˜ë¦¬ ì™„ë£Œ', { code });
      console.log('âœ… ì·¨ì†Œ ì²˜ë¦¬ ì™„ë£Œ:', code);
      return 'SUCCESS';
    }
    
    writeLog('CALLBACK_STATE_UPDATE', 'â³ PayApp ìƒíƒœ ì—…ë°ì´íŠ¸', { payState });
    console.log('â³ PayApp ìƒíƒœ ì—…ë°ì´íŠ¸:', payState);
    return 'SUCCESS';
    
  } catch (error) {
    writeLog('CALLBACK_FATAL_ERROR', 'ğŸ’¥ ì½œë°± ì²˜ë¦¬ ì¤‘ ì¹˜ëª…ì  ì˜¤ë¥˜', { 
      error: error.toString(), 
      stack: error.stack,
      data: data
    });
    console.error('ğŸ’¥ ì½œë°± ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error.toString());
    console.error('ğŸ“‹ ì˜¤ë¥˜ ìƒì„¸:', error);
    return 'SUCCESS';
  }
}

// ğŸ”„ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
function updatePaymentStatus(rowIndex, status, mulNo, token) {
  try {
    const sheet = SpreadsheetApp.openById(CONFIG.SHEET_ID).getActiveSheet();
    sheet.getRange(rowIndex, 10).setValue(status);
    if (mulNo) sheet.getRange(rowIndex, 11).setValue(mulNo);
    if (token) sheet.getRange(rowIndex, 12).setValue(token);
  } catch (error) {
    console.error('ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
  }
}

function clearReservation(rowIndex) {
  try {
    const sheet = SpreadsheetApp.openById(CONFIG.SHEET_ID).getActiveSheet();
    sheet.getRange(rowIndex, 8).setValue('');
    sheet.getRange(rowIndex, 9).setValue('');
    sheet.getRange(rowIndex, 10).setValue('');
    sheet.getRange(rowIndex, 11).setValue('');
    sheet.getRange(rowIndex, 12).setValue('');
  } catch (error) {
    console.error('ì˜ˆì•½ í•´ì œ ì˜¤ë¥˜:', error);
  }
}

// ğŸ”’ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
function isCallbackAlreadyProcessed(token, mulNo) {
  try {
    const cache = CacheService.getScriptCache();
    const key = 'callback_' + token + '_' + mulNo;
    return cache.get(key) !== null;
  } catch (error) {
    console.error('ìºì‹œ í™•ì¸ ì˜¤ë¥˜:', error);
    return false;
  }
}

function recordCallbackProcessed(token, mulNo) {
  try {
    const cache = CacheService.getScriptCache();
    const key = 'callback_' + token + '_' + mulNo;
    cache.put(key, 'processed', 3600);
  } catch (error) {
    console.error('ìºì‹œ ì €ì¥ ì˜¤ë¥˜:', error);
  }
}

// ğŸ“§ ì´ë©”ì¼ ë°œì†¡
function sendCodeEmail(code, licenseType, buyerEmail) {
  try {
    const subject = '[LittleScienceAI] ' + licenseType + ' ë°œê¸‰ ì™„ë£Œ';
    
    const textBody = 'ì•ˆë…•í•˜ì„¸ìš”! LittleScienceAIë¥¼ êµ¬ë§¤í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.\n\n' +
                     'ì´ìš©ê¶Œ ì½”ë“œ: ' + code + '\n' +
                     'ì´ìš©ê¸°ê°„: ' + licenseType + '\n' +
                     'ì ‘ì† ë§í¬: https://little-science-ai-918631854597.asia-northeast3.run.app/\n\n' +
                     'ì´ìš© ë°©ë²•:\n' +
                     '1. ìœ„ ë§í¬ë¡œ ì ‘ì†\n' +
                     '2. ì¸ì¦ í‚¤ì— ì½”ë“œ ì…ë ¥\n' +
                     '3. ê³¼í•™ ë…¼ë¬¸ íƒìƒ‰ ì‹œì‘!\n\n' +
                     'ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ì—°ë½ì£¼ì„¸ìš”.\n\n' +
                     'ê°ì‚¬í•©ë‹ˆë‹¤.\n' +
                     'LittleScienceAI íŒ€';
    
    const htmlBody = '<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>LittleScienceAI ì´ìš©ê¶Œ ë°œê¸‰</title></head><body style="margin: 0; padding: 0; font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8f9fa; line-height: 1.6;"><div style="max-width: 600px; margin: 20px auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"><div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px 20px; text-align: center; color: white;"><h1 style="margin: 0; font-size: 28px; font-weight: bold;">LittleScienceAI</h1><p style="margin: 10px 0 0 0; font-size: 16px; opacity: 0.9;">ê³¼í•™ë…¼ë¬¸ ì£¼ì œ íƒìƒ‰ ë„ìš°ë¯¸</p></div><div style="padding: 30px 20px;"><div style="text-align: center; margin-bottom: 30px;"><h2 style="color: #333; margin: 0 0 10px 0; font-size: 24px;">ì´ìš©ê¶Œ ë°œê¸‰ ì™„ë£Œ</h2><p style="color: #666; margin: 0; font-size: 16px;">êµ¬ë§¤í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!</p></div><div style="background: #f8f9ff; border: 2px solid #667eea; border-radius: 12px; padding: 25px; margin: 20px 0; text-align: center;"><div style="color: #667eea; font-size: 18px; font-weight: bold; margin-bottom: 15px;">' + licenseType + '</div><div style="background: white; border: 2px dashed #667eea; border-radius: 8px; padding: 20px; margin: 15px 0;"><p style="color: #333; margin: 0 0 10px 0; font-size: 14px; font-weight: bold;">ì´ìš©ê¶Œ ì½”ë“œ</p><div style="font-size: 24px; font-weight: bold; color: #667eea; letter-spacing: 2px; font-family: \'Courier New\', monospace; user-select: all; -webkit-user-select: all; -moz-user-select: all; -ms-user-select: all; cursor: text; padding: 10px; background: #f8f9ff; border-radius: 6px;">' + code + '</div><p style="color: #888; margin: 10px 0 0 0; font-size: 12px;">ìœ„ ì½”ë“œë¥¼ ë§ˆìš°ìŠ¤ë¡œ ì„ íƒí•˜ì—¬ ë³µì‚¬í•˜ì„¸ìš”</p></div></div><div style="background: #e8f5e8; border: 1px solid #28a745; border-radius: 12px; padding: 25px; margin: 20px 0;"><h3 style="color: #28a745; margin: 0 0 15px 0; font-size: 18px;">ì´ìš© ë°©ë²•</h3><ol style="color: #333; margin: 0; padding-left: 20px;"><li style="margin-bottom: 8px;">ì•„ë˜ ë§í¬ë¡œ ì ‘ì†í•˜ì„¸ìš”</li><li style="margin-bottom: 8px;">ì¸ì¦ í‚¤ ì…ë ¥ë€ì— ìœ„ì˜ ì´ìš©ê¶Œ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</li><li style="margin-bottom: 8px;">ê³¼í•™ ë…¼ë¬¸ íƒìƒ‰ì„ ì‹œì‘í•˜ì„¸ìš”!</li></ol></div><div style="text-align: center; margin: 30px 0;"><a href="https://little-science-ai-918631854597.asia-northeast3.run.app/" style="display: inline-block; background: linear-gradient(45deg, #28a745, #20c997); color: white; text-decoration: none; padding: 15px 30px; border-radius: 25px; font-weight: bold; font-size: 16px; box-shadow: 0 4px 12px rgba(40,167,69,0.3);">LittleScienceAI ì ‘ì†í•˜ê¸°</a></div><div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 20px 0;"><p style="color: #856404; margin: 0; font-size: 14px; text-align: center;"><strong>ì´ìš©ê¶Œ ìœ íš¨ê¸°ê°„:</strong> ì½”ë“œ ì…ë ¥ í›„ ' + licenseType.replace('ì´ìš©ê¶Œ', '') + ' ë™ì•ˆ ì´ìš© ê°€ëŠ¥</p></div></div><div style="background: #f8f9fa; padding: 20px; text-align: center; border-top: 1px solid #e9ecef;"><p style="color: #666; margin: 0 0 10px 0; font-size: 14px;">ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ì—°ë½ì£¼ì„¸ìš”</p><div style="margin: 15px 0;"><span style="background: #667eea; color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">ì¹´ì¹´ì˜¤í†¡ ì±„ë„: ë¦¬í‹€ì‚¬ì´ì–¸ìŠ¤AI</span></div><p style="color: #999; margin: 15px 0 0 0; font-size: 12px;">LittleScienceAI íŒ€<br>ì´ ì´ë©”ì¼ì€ ìë™ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p></div></div></body></html>';
    
    GmailApp.sendEmail(
      buyerEmail, 
      subject, 
      textBody,
      {
        htmlBody: htmlBody
      }
    );
    
    console.log('HTML ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ:', buyerEmail);
    
  } catch (error) {
    console.error('ì´ë©”ì¼ ë°œì†¡ ì˜¤ë¥˜:', error);
  }
}

// ğŸ¨ HTML í˜ì´ì§€ ìƒì„± (X-Frame-Options ë¬¸ì œ í•´ê²°)
function createRedirectPage(payUrl, mulNo) {
  return '<!DOCTYPE html><html><head><title>PayApp ê²°ì œì°½ ì´ë™</title><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>body { font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center; } .redirect { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); display: inline-block; max-width: 500px; } h1 { color: #333; margin-bottom: 20px; } p { color: #666; margin: 10px 0; } .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } .manual-btn { background: #28a745; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; margin: 20px 10px; font-size: 16px; text-decoration: none; display: inline-block; }</style><script>function openPaymentWindow() { window.open(\'' + payUrl + '\', \'payapp_payment\', \'width=800,height=700,scrollbars=yes,resizable=yes\'); } setTimeout(openPaymentWindow, 1000);</script></head><body><div class="redirect"><h1>ğŸ’³ PayApp ê²°ì œ</h1><div class="spinner"></div><p>PayApp ê²°ì œì°½ì„ ìƒˆì°½ìœ¼ë¡œ ì—´ê³  ìˆìŠµë‹ˆë‹¤...</p><p><small>ê²°ì œ ë²ˆí˜¸: ' + mulNo + '</small></p><a href="javascript:openPaymentWindow()" class="manual-btn">ê²°ì œì°½ì´ ì•ˆì—´ë¦¬ë©´ í´ë¦­</a><p style="font-size: 12px; color: #888; margin-top: 20px;">íŒì—… ì°¨ë‹¨ì´ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´ ìœ„ ë²„íŠ¼ì„ ì§ì ‘ í´ë¦­í•´ì£¼ì„¸ìš”</p></div></body></html>';
}

function createErrorPage(message) {
  return '<!DOCTYPE html><html><head><title>ì˜¤ë¥˜</title><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><style>body { font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 50px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center; } .error { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); display: inline-block; max-width: 500px; } h1 { color: #e74c3c; margin-bottom: 20px; } p { color: #666; margin: 10px 0; } .close-btn { background: #e74c3c; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-top: 20px; font-size: 16px; }</style></head><body><div class="error"><h1>âŒ ì˜¤ë¥˜</h1><p><strong>' + message + '</strong></p><button class="close-btn" onclick="window.close()">ì°½ ë‹«ê¸°</button></div></body></html>';
}

// ğŸ” ê´€ë¦¬ì í•¨ìˆ˜ë“¤
function getCurrentUrl() {
  const devUrl = ScriptApp.getService().getUrl();
  const prodUrl = CONFIG.FEEDBACK_URL;
  
  console.log('ê°œë°œ ëª¨ë“œ URL:', devUrl);
  console.log('ì‹¤ì œ ë°°í¬ URL:', prodUrl);
  console.log('PayApp FeedbackURLì— ì„¤ì •í•  URL:', prodUrl);
  
  return {
    dev: devUrl,
    production: prodUrl,
    useForPayApp: prodUrl
  };
}

function testPurchase() {
  console.log('=== êµ¬ë§¤ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
  const result = purchaseLicense("7ì¼ ì´ìš©ê¶Œ", "test@email.com");
  console.log('í…ŒìŠ¤íŠ¸ ê²°ê³¼:', result);
  console.log('=== êµ¬ë§¤ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===');
  return result;
}

function checkStock() {
  try {
    const sheet = SpreadsheetApp.openById(CONFIG.SHEET_ID).getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    const stock = {
      '7ì¼ ì´ìš©ê¶Œ': 0,
      '15ì¼ ì´ìš©ê¶Œ': 0,
      '30ì¼ ì´ìš©ê¶Œ': 0
    };
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][4] === '' && (!data[i][9] || data[i][9] === '')) {
        const type = data[i][1];
        if (stock.hasOwnProperty(type)) {
          stock[type]++;
        }
      }
    }
    
    console.log('ğŸ“¦ í˜„ì¬ ì¬ê³  í˜„í™©:', stock);
    return stock;
    
  } catch (error) {
    console.error('ì¬ê³  í™•ì¸ ì˜¤ë¥˜:', error);
    return null;
  }
}

function cleanupFailedTransactions() {
  try {
    const sheet = SpreadsheetApp.openById(CONFIG.SHEET_ID).getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
    let cleanedCount = 0;
    
    for (let i = 1; i < data.length; i++) {
      const status = data[i][9];
      const timestamp = data[i][8];
      
      // 5ë¶„ ì´ìƒ ì§€ë‚œ PENDING ë˜ëŠ” PAYAPP_REQUESTED ìƒíƒœì˜ ê±°ë˜ ì •ë¦¬
      if ((status === 'PENDING' || status === 'PAYAPP_REQUESTED') && 
          timestamp && new Date(timestamp) < fiveMinutesAgo) {
        
        clearReservation(i + 1);
        cleanedCount++;
        console.log('ì •ë¦¬ëœ ê±°ë˜:', data[i][0], data[i][7], status);
      }
    }
    
    console.log('ì´', cleanedCount, 'ê°œì˜ ì‹¤íŒ¨í•œ ê±°ë˜ë¥¼ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.');
    return cleanedCount;
    
  } catch (error) {
    console.error('ê±°ë˜ ì •ë¦¬ ì˜¤ë¥˜:', error);
    return -1;
  }
}

// ğŸ” ë¡œê·¸ í™•ì¸ í•¨ìˆ˜ (ìƒˆë¡œ ì¶”ê°€)
function checkRecentLogs(count = 20) {
  try {
    const sheet = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    let logSheet;
    
    try {
      logSheet = sheet.getSheetByName('PayApp_ë¡œê·¸');
    } catch (e) {
      console.log('ë¡œê·¸ ì‹œíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ì§ ë¡œê·¸ê°€ ê¸°ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return [];
    }
    
    const lastRow = logSheet.getLastRow();
    if (lastRow <= 1) {
      console.log('ë¡œê·¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return [];
    }
    
    const startRow = Math.max(2, lastRow - count + 1);
    const logs = logSheet.getRange(startRow, 1, lastRow - startRow + 1, 5).getValues();
    
    console.log('=== ìµœê·¼', logs.length, 'ê°œ ë¡œê·¸ ===');
    logs.forEach((log, index) => {
      console.log(`${startRow + index}. [${log[0]}] ${log[1]}: ${log[2]}`);
      if (log[3]) {
        console.log('   ë°ì´í„°:', log[3]);
      }
    });
    console.log('=== ë¡œê·¸ í™•ì¸ ì™„ë£Œ ===');
    
    return logs;
    
  } catch (error) {
    console.error('ë¡œê·¸ í™•ì¸ ì˜¤ë¥˜:', error);
    return [];
  }
}

// ğŸ§¹ ë¡œê·¸ ì´ˆê¸°í™” í•¨ìˆ˜ (í•„ìš”ì‹œ ì‚¬ìš©)
function clearLogs() {
  try {
    const sheet = SpreadsheetApp.openById(CONFIG.SHEET_ID);
    const logSheet = sheet.getSheetByName('PayApp_ë¡œê·¸');
    
    const lastRow = logSheet.getLastRow();
    if (lastRow > 1) {
      logSheet.deleteRows(2, lastRow - 1);
      console.log('ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      console.log('ì‚­ì œí•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }
    
  } catch (error) {
    console.error('ë¡œê·¸ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
  }
}
