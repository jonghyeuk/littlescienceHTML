// âœ… PayApp ì—°ë™ ì •ë³´ - ì§„ì§œ ì •í™•í•œ ê°’ìœ¼ë¡œ ìˆ˜ì •!
const PAYAPP_CONFIG = {
  userid: 'kstore101',
  linkkey: 'CCiZIswPVKh+xt+QKt/+b+1DPJnCCRVaOgT+oqg6zaM=',    // âœ… ì •í™•í•œ ê°’!
  linkval: 'CCiZIswPVKh+xt+QKt/+bxTdEGsBOXZ7gUSUjzGppZM='     // âœ… ì •í™•í•œ ê°’!
};

const SHEET_ID = '1ogVkRidiKcL2fcn9DTgPFlCp-nehjDZMRhx7EJqKIr0';

function doGet(e) {
  try {
    const action = e.parameter.action;
    console.log('doGet í˜¸ì¶œë¨:', action);
    
    if (action === 'paymentComplete') {
      return handlePaymentComplete(e.parameter);
    }
    
    return HtmlService.createHtmlOutput(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>LittleScienceAI</title>
        <meta charset="UTF-8">
        <style>
          body { font-family: Arial; text-align: center; padding: 50px; background: #f8f9fa; }
          .info { background: white; padding: 30px; border-radius: 15px; max-width: 400px; margin: 0 auto; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        </style>
      </head>
      <body>
        <div class="info">
          <h1>ğŸ§ª LittleScienceAI</h1>
          <p>ê³¼í•™ë…¼ë¬¸ ì£¼ì œ íƒìƒ‰ ë„ìš°ë¯¸</p>
          <p><a href="https://little-science-ai-918631854597.asia-northeast3.run.app/">ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™</a></p>
        </div>
      </body>
      </html>
    `);
  } catch (error) {
    console.error('doGet ì—ëŸ¬:', error);
    return createErrorPage('í˜ì´ì§€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

function doPost(e) {
  try {
    console.log('=== doPost í˜¸ì¶œë¨ ===');
    console.log('ì „ì²´ íŒŒë¼ë¯¸í„°:', JSON.stringify(e.parameter));
    
    if (e.parameter.pay_state || e.parameter.mul_no || e.parameter.userid) {
      console.log('âœ… PayApp ì½œë°± ê°ì§€');
      return handlePaymentCallback(e);
    }
    
    const action = e.parameter.action;
    if (action === 'paymentCallback') {
      return handlePaymentCallback(e);
    }
    
    if (action === 'paymentComplete') {
      return handlePaymentComplete(e.parameter);
    }
    
    console.log('âŒ ì•Œ ìˆ˜ ì—†ëŠ” ìš”ì²­');
    return createErrorPage('ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤.');
    
  } catch (error) {
    console.error('doPost ì—ëŸ¬:', error);
    return createErrorPage('ì„œë²„ ì˜¤ë¥˜: ' + error.toString());
  }
}

function isDuplicateOrder(orderNumber, payappOrderNumber = null) {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][9] === orderNumber) {
        console.log(`âš ï¸ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€: ì£¼ë¬¸ë²ˆí˜¸ ${orderNumber} ì´ë¯¸ ì²˜ë¦¬ë¨`);
        return true;
      }
      
      if (payappOrderNumber && data[i][13] === payappOrderNumber) {
        console.log(`âš ï¸ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€: PayApp ì£¼ë¬¸ë²ˆí˜¸ ${payappOrderNumber} ì´ë¯¸ ì²˜ë¦¬ë¨`);
        return true;
      }
    }
    return false;
  } catch (error) {
    console.error('ì¤‘ë³µ ì²´í¬ ì˜¤ë¥˜:', error);
    return false;
  }
}

function handlePaymentCallback(e) {
  try {
    console.log('=== PayApp ê²°ì œ ì½œë°± ë°›ìŒ ===');
    
    // âœ… ìœ ì—°í•œ ë³´ì•ˆ ê²€ì¦ (linkvalì´ ì—†ìœ¼ë©´ í†µê³¼, ìˆëŠ”ë° í‹€ë¦¬ë©´ FAIL)
    const receivedLinkval = e.parameter.linkval;
    if (receivedLinkval && receivedLinkval !== PAYAPP_CONFIG.linkval) {
      console.error('âš ï¸ PayApp ë³´ì•ˆ ê²€ì¦ ì‹¤íŒ¨ - linkval ë¶ˆì¼ì¹˜');
      console.error(`ë°›ì€ ê°’: "${receivedLinkval}"`);
      console.error(`ì˜ˆìƒ ê°’: "${PAYAPP_CONFIG.linkval}"`);
      return HtmlService.createHtmlOutput('FAIL'); // âœ… HtmlService ì‚¬ìš©
    }
    console.log('âœ… PayApp ë³´ì•ˆ ê²€ì¦ ì„±ê³µ (ë˜ëŠ” linkval ì—†ìŒ)');
    
    const payResult = {
      pay_state: e.parameter.pay_state,
      var1: e.parameter.var1,
      var2: e.parameter.var2,
      mul_no: e.parameter.mul_no,
      pay_price: e.parameter.pay_price,
      pay_type: e.parameter.pay_type,
      pay_time: e.parameter.pay_time
    };
    
    console.log(`ê²°ì œ ìƒíƒœ: ${payResult.pay_state}`);
    console.log(`ì£¼ë¬¸ë²ˆí˜¸: ${payResult.var1}`);
    console.log(`PayApp ì£¼ë¬¸ë²ˆí˜¸: ${payResult.mul_no}`);
    
    // âœ… ì˜ˆì „ ë°©ì‹ì²˜ëŸ¼ ë” ê´€ëŒ€í•œ ê²°ì œ ìƒíƒœ ì²´í¬
    const payState = payResult.pay_state;
    console.log(`ê²°ì œ ìƒíƒœ í™•ì¸: "${payState}" (íƒ€ì…: ${typeof payState})`);
    
    // Y, '4', 4 ëª¨ë“  ê²½ìš°ë¥¼ ê²°ì œ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬ (ì˜ˆì „ ë°©ì‹)
    if (payState === 'Y' || payState === '4' || payState === 4) {
      console.log('âœ… ê²°ì œ ì™„ë£Œ í™•ì¸ë¨ - ì´ìš©ê¶Œ ë°œê¸‰ ì‹œì‘');
    } else {
      console.log(`âŒ ê²°ì œ ë¯¸ì™„ë£Œ ìƒíƒœ: ${payState} - SUCCESS ì‘ë‹µí•˜ê³  ì¢…ë£Œ`);
      return HtmlService.createHtmlOutput('SUCCESS'); // âœ… HtmlService ì‚¬ìš©
    }

    const orderNumber = payResult.var1 || `AUTO_${new Date().getTime()}`;
    const payappOrderNumber = payResult.mul_no;
    
    if (isDuplicateOrder(orderNumber, payappOrderNumber)) {
      console.log('ì´ë¯¸ ì²˜ë¦¬ëœ ì£¼ë¬¸ - SUCCESS ì‘ë‹µ');
      return HtmlService.createHtmlOutput('SUCCESS'); // âœ… HtmlService ì‚¬ìš©
    }
    
    console.log('âœ… ìƒˆë¡œìš´ ì£¼ë¬¸ - ì´ìš©ê¶Œ ë°œê¸‰ ì§„í–‰');
      
    let orderInfo;
    try {
      if (payResult.var2) {
        orderInfo = JSON.parse(payResult.var2);
        console.log('âœ… orderData íŒŒì‹± ì„±ê³µ:', orderInfo);
      } else {
        console.warn('âš ï¸ orderData ì—†ìŒ - ê¸°ë³¸ê°’ ì‚¬ìš©');
        orderInfo = {
          email: 'jonghyeuk@gmail.com',
          license: '7ì¼ ì´ìš©ê¶Œ',
          price: 7500
        };
      }
    } catch (parseError) {
      console.error('âŒ ì£¼ë¬¸ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', parseError);
      orderInfo = {
        email: 'jonghyeuk@gmail.com',
        license: '7ì¼ ì´ìš©ê¶Œ',
        price: 7500
      };
    }
    
    const result = purchaseLicense(orderInfo.license, orderInfo.email, {
      orderNumber: orderNumber,
      payappOrderNumber: payappOrderNumber,
      payType: payResult.pay_type || 'unknown',
      payTime: payResult.pay_time || new Date().toISOString(),
      payPrice: payResult.pay_price || orderInfo.price
    });
    
    console.log('ğŸ« ì´ìš©ê¶Œ ë°œê¸‰ ê²°ê³¼:', result);
    
    if (result.success) {
      console.log('âœ… PayApp ê²°ì œ ì™„ë£Œ - ì´ìš©ê¶Œ ë°œê¸‰ ì„±ê³µ:', result.code);
    } else {
      console.error('âŒ ì´ìš©ê¶Œ ë°œê¸‰ ì‹¤íŒ¨:', result.message);
    }
    
    // âœ… ëª¨ë“  ê²½ìš°ì— ì˜ˆìœ SUCCESS í˜ì´ì§€ë¡œ ì‘ë‹µ
    return HtmlService.createHtmlOutput(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>ê²°ì œ ì²˜ë¦¬ ì™„ë£Œ</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          body { 
            font-family: 'Segoe UI', sans-serif; 
            text-align: center; 
            padding: 50px; 
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
          }
          .success { 
            background: white; 
            padding: 40px; 
            border-radius: 20px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
            display: inline-block;
            max-width: 500px;
            animation: slideIn 0.5s ease-out;
          }
          @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
          }
          .check-icon {
            font-size: 80px;
            color: #28a745;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out;
          }
          @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
          }
          h1 { color: #333; margin-bottom: 20px; }
          p { color: #666; margin: 15px 0; line-height: 1.6; }
          .email-info {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #28a745;
          }
          .main-btn {
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
          }
          .main-btn:hover {
            background: #218838;
            transform: translateY(-2px);
          }
        </style>
      </head>
      <body>
        <div class="success">
          <div class="check-icon">âœ…</div>
          <h1>ğŸ‰ ê²°ì œ ì™„ë£Œ!</h1>
          
          <div class="email-info">
            <p><strong>ğŸ“§ ì´ìš©ê¶Œ ì½”ë“œê°€ ì´ë©”ì¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!</strong></p>
            <p>LittleScienceAI <strong>7ì¼ ì´ìš©ê¶Œ</strong></p>
          </div>
          
          <p style="color: #28a745; font-weight: bold;">âœ¨ ê²°ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤</p>
          <p>ğŸ“± ì ì‹œ í›„ ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”</p>
          
          <a href="https://little-science-ai-918631854597.asia-northeast3.run.app/" class="main-btn">ğŸ§ª LittleScienceAI ì‹œì‘í•˜ê¸°</a>
          
          <p style="margin-top: 30px; font-size: 12px; color: #999;">
            ğŸ’Œ ì´ë©”ì¼ì´ ë„ì°©í•˜ì§€ ì•Šìœ¼ë©´ ìŠ¤íŒ¸í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”<br>
            ğŸ†˜ ë¬¸ì˜: ì¹´ì¹´ì˜¤í†¡ ì±„ë„ 'ë¦¬í‹€ì‚¬ì´ì–¸ìŠ¤AI'
          </p>
        </div>
        
        <script>
          // 3ì´ˆ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ìë™ ì´ë™
          setTimeout(() => {
            window.location.href = 'https://little-science-ai-918631854597.asia-northeast3.run.app/';
          }, 3000);
        </script>
      </body>
      </html>
    `);
    
  } catch (error) {
    console.error('ğŸ’¥ PayApp ì½œë°± ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    return HtmlService.createHtmlOutput('SUCCESS'); // âœ… HtmlService ì‚¬ìš©
  }
}

function handlePaymentComplete(params) {
  try {
    const email = params.email;
    const license = params.license;
    
    console.log(`ê²°ì œ ì™„ë£Œ í˜ì´ì§€: ${email}, ${license}`);
    
    const html = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>ê²°ì œ ì™„ë£Œ</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          body { 
            font-family: 'Segoe UI', sans-serif; 
            text-align: center; 
            padding: 50px; 
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
          }
          .success { 
            background: white; 
            padding: 40px; 
            border-radius: 20px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); 
            display: inline-block;
            max-width: 500px;
          }
          .check-icon {
            font-size: 80px;
            color: #28a745;
            margin-bottom: 20px;
          }
          h1 { color: #333; margin-bottom: 20px; }
          p { color: #666; margin: 15px 0; line-height: 1.6; }
          .email-info {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #28a745;
          }
          .main-btn {
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
          }
          .steps {
            text-align: left;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
          }
          .steps h3 {
            color: #28a745;
            margin-bottom: 15px;
            text-align: center;
          }
          .steps ol {
            color: #666;
            line-height: 1.8;
          }
        </style>
      </head>
      <body>
        <div class="success">
          <div class="check-icon">âœ…</div>
          <h1>ê²°ì œ ì™„ë£Œ!</h1>
          
          <div class="email-info">
            <p><strong>ğŸ“§ ${email}</strong></p>
            <p><strong>${license}</strong> ì´ìš©ê¶Œ ì½”ë“œê°€<br>ì´ë©”ì¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
          </div>
          
          <div class="steps">
            <h3>ğŸš€ ì´ìš© ë°©ë²•</h3>
            <ol>
              <li><strong>ì´ë©”ì¼ í™•ì¸</strong> - ë°œì†¡ëœ ì´ìš©ê¶Œ ì½”ë“œ í™•ì¸</li>
              <li><strong>ì‚¬ì´íŠ¸ ì ‘ì†</strong> - LittleScienceAI ë©”ì¸ í˜ì´ì§€ ë°©ë¬¸</li>
              <li><strong>ì½”ë“œ ì…ë ¥</strong> - ì¸ì¦ í‚¤ ë©”ë‰´ì—ì„œ ì½”ë“œ ì…ë ¥</li>
              <li><strong>íƒìƒ‰ ì‹œì‘</strong> - ê³¼í•™ ë…¼ë¬¸ ì£¼ì œ íƒìƒ‰ ì‹œì‘!</li>
            </ol>
          </div>
          
          <a href="https://little-science-ai-918631854597.asia-northeast3.run.app/" class="main-btn">ğŸ§ª LittleScienceAI ì‹œì‘í•˜ê¸°</a>
          
          <p style="margin-top: 30px; font-size: 12px; color: #999;">
            ğŸ’Œ ì´ë©”ì¼ì´ ë„ì°©í•˜ì§€ ì•Šìœ¼ë©´ ìŠ¤íŒ¸í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”.<br>
            ğŸ†˜ ë¬¸ì˜: ì¹´ì¹´ì˜¤í†¡ ì±„ë„ 'ë¦¬í‹€ì‚¬ì´ì–¸ìŠ¤AI'
          </p>
        </div>
      </body>
      </html>
    `;
    
    return HtmlService.createHtmlOutput(html);
    
  } catch (error) {
    console.error('ê²°ì œ ì™„ë£Œ í˜ì´ì§€ ì˜¤ë¥˜:', error);
    return createErrorPage('í˜ì´ì§€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
}

function purchaseLicense(licenseType, buyerEmail, paymentInfo = null) {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    console.log(`ì´ìš©ê¶Œ ë°œê¸‰: ${licenseType}, ${buyerEmail}`);
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] === licenseType && data[i][4] === '') {
        
        console.log(`ì‚¬ìš© ê°€ëŠ¥í•œ ì½”ë“œ ë°œê²¬: ${data[i][0]}`);
        
        sheet.getRange(i + 1, 8).setValue(buyerEmail);
        sheet.getRange(i + 1, 9).setValue(new Date());
        
        if (paymentInfo) {
          sheet.getRange(i + 1, 10).setValue(paymentInfo.orderNumber);
          sheet.getRange(i + 1, 11).setValue(paymentInfo.payType);
          sheet.getRange(i + 1, 12).setValue(paymentInfo.payPrice);
          sheet.getRange(i + 1, 13).setValue(paymentInfo.payTime);
          
          if (paymentInfo.payappOrderNumber) {
            sheet.getRange(i + 1, 14).setValue(paymentInfo.payappOrderNumber);
          }
        }
        
        const code = data[i][0];
        sendCodeEmail(code, licenseType, buyerEmail, paymentInfo);
        
        console.log(`ì´ìš©ê¶Œ ë°œê¸‰ ì„±ê³µ: ${code} â†’ ${buyerEmail}`);
        
        return {
          success: true,
          code: code,
          message: 'PayApp ê²°ì œ ì™„ë£Œ! ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'
        };
      }
    }
    
    console.log(`ì¬ê³  ë¶€ì¡±: ${licenseType}`);
    return {
      success: false,
      message: `${licenseType} ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.`
    };
    
  } catch (error) {
    console.error('ì´ìš©ê¶Œ ë°œê¸‰ ì˜¤ë¥˜:', error);
    return {
      success: false,
      message: 'ì‹œìŠ¤í…œ ì˜¤ë¥˜: ' + error.toString()
    };
  }
}

function sendCodeEmail(code, licenseType, buyerEmail, paymentInfo = null) {
  try {
    const subject = `[LittleScienceAI] ${licenseType} ë°œê¸‰ ì™„ë£Œ (PayApp ê²°ì œ)`;
    
    const htmlBody = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>ì´ìš©ê¶Œ ë°œê¸‰ ì•ˆë‚´</title>
    </head>
    <body style="font-family: Arial; color: #333; max-width: 600px; margin: 0 auto; padding: 20px;">
      
      <div style="background: #28a745; color: white; padding: 30px; text-align: center; border-radius: 10px;">
        <h1 style="margin: 0; font-size: 28px;">LittleScienceAI</h1>
        <p style="margin: 10px 0 0 0; font-size: 18px;">PayApp ê²°ì œ ì™„ë£Œ ë° ì´ìš©ê¶Œ ë°œê¸‰</p>
      </div>
      
      <div style="margin: 30px 0;">
        <h2 style="color: #28a745;">ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰</h2>
        <p>LittleScienceAIë¥¼ êµ¬ë§¤í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>
        
        <div style="background: #f5f5f5; border: 3px solid #28a745; padding: 25px; text-align: center; border-radius: 10px; margin: 25px 0;">
          <p style="margin: 0; color: #666;">ê·€í•˜ì˜ ì´ìš©ê¶Œ ì½”ë“œ</p>
          <h1 style="margin: 15px 0; color: #28a745; font-size: 32px; letter-spacing: 2px;">${code}</h1>
          <p style="margin: 0; color: #666; font-weight: bold;">${licenseType}</p>
        </div>
        
        <div style="background: #e8f4fd; padding: 20px; border-radius: 8px; margin: 25px 0;">
          <h3 style="margin-top: 0; color: #2e7d32;">ğŸš€ ì‚¬ìš© ë°©ë²•</h3>
          <p><strong>1ë‹¨ê³„:</strong> LittleScienceAI ì›¹ì‚¬ì´íŠ¸ì— ì ‘ì†</p>
          <p><strong>2ë‹¨ê³„:</strong> ì¸ì¦ í‚¤ ì…ë ¥ ë©”ë‰´ ì„ íƒ</p>
          <p><strong>3ë‹¨ê³„:</strong> ìœ„ì˜ ì½”ë“œë¥¼ ì…ë ¥</p>
          <p><strong>4ë‹¨ê³„:</strong> ê³¼í•™ ë…¼ë¬¸ íƒìƒ‰ ì‹œì‘!</p>
        </div>
        
        <div style="text-align: center; margin: 30px 0;">
          <a href="https://little-science-ai-918631854597.asia-northeast3.run.app/" style="background: #28a745; color: white; padding: 15px 35px; text-decoration: none; border-radius: 25px; font-size: 16px; font-weight: bold;">ì§€ê¸ˆ ë°”ë¡œ ì‹œì‘í•˜ê¸°</a>
        </div>
      </div>
      
      <div style="border-top: 1px solid #ddd; padding-top: 20px; text-align: center; color: #666;">
        <p>ì•ˆì „í•œ PayApp ê²°ì œ ì‹œìŠ¤í…œì„ ì´ìš©í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>
        <p>ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì¹´ì¹´ì˜¤í†¡ ì±„ë„ 'ë¦¬í‹€ì‚¬ì´ì–¸ìŠ¤AI'ë¡œ ì—°ë½ì£¼ì„¸ìš”.</p>
        <p><strong>LittleScienceAI íŒ€</strong></p>
      </div>
      
    </body>
    </html>
    `;
    
    const textBody = `
LittleScienceAI ${licenseType} ë°œê¸‰ ì™„ë£Œ (PayApp ê²°ì œ)

ğŸ‰ ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
LittleScienceAIë¥¼ êµ¬ë§¤í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.

ğŸ« ì´ìš©ê¶Œ ì½”ë“œ: ${code}
â° ì´ìš©ê¸°ê°„: ${licenseType}
ğŸ”— ì ‘ì† ë§í¬: https://little-science-ai-918631854597.asia-northeast3.run.app/

ğŸ“ ì´ìš© ë°©ë²•:
1. ìœ„ ë§í¬ë¡œ ì ‘ì†
2. ì¸ì¦ í‚¤ì— ì½”ë“œ ì…ë ¥: ${code}
3. ê³¼í•™ ë…¼ë¬¸ íƒìƒ‰ ì‹œì‘!

ğŸ’¡ ì´ìš©ê¶Œ ì½”ë“œëŠ” ì•ˆì „í•˜ê²Œ ë³´ê´€í•´ì£¼ì„¸ìš”.

ê°ì‚¬í•©ë‹ˆë‹¤.
LittleScienceAI íŒ€
    `;
    
    GmailApp.sendEmail(
      buyerEmail, 
      subject, 
      textBody,
      {
        htmlBody: htmlBody
      }
    );
    
    console.log(`ì´ë©”ì¼ ë°œì†¡: ${buyerEmail}`);
    
  } catch (error) {
    console.error('ì´ë©”ì¼ ë°œì†¡ ì˜¤ë¥˜:', error);
  }
}

function createErrorPage(message) {
  const html = `
  <!DOCTYPE html>
  <html>
  <head>
    <title>ì˜¤ë¥˜ ë°œìƒ</title>
    <meta charset="UTF-8">
    <style>
      body { 
        font-family: Arial; 
        text-align: center; 
        padding: 50px; 
        background: #ffe6e6;
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .error { 
        background: white; 
        padding: 40px; 
        border-radius: 20px; 
        max-width: 500px;
      }
      h1 { color: #e74c3c; }
      p { color: #666; }
    </style>
  </head>
  <body>
    <div class="error">
      <h1>âš ï¸ ì˜¤ë¥˜ ë°œìƒ</h1>
      <p>${message}</p>
    </div>
  </body>
  </html>
  `;
  
  return HtmlService.createHtmlOutput(html);
}

function emergencyIssueLicense() {
  const buyerEmail = 'jonghyeuk@gmail.com';
  const licenseType = '7ì¼ ì´ìš©ê¶Œ';
  const paymentAmount = 7500;
  
  console.log('=== ê¸´ê¸‰ ìˆ˜ë™ ì´ìš©ê¶Œ ë°œê¸‰ ì‹œì‘ ===');
  
  const paymentInfo = {
    orderNumber: 'EMERGENCY_' + Date.now(),
    payType: 'card',
    payTime: new Date().toISOString(),
    payPrice: paymentAmount,
    manual: true
  };
  
  const result = purchaseLicense(licenseType, buyerEmail, paymentInfo);
  console.log('ê¸´ê¸‰ ë°œê¸‰ ê²°ê³¼:', result);
  
  return result;
}

function checkStock() {
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getActiveSheet();
    const data = sheet.getDataRange().getValues();
    
    const stock = {
      '7ì¼ ì´ìš©ê¶Œ': 0,
      '15ì¼ ì´ìš©ê¶Œ': 0,
      '30ì¼ ì´ìš©ê¶Œ': 0
    };
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][4] === '') {
        const type = data[i][1];
        if (stock.hasOwnProperty(type)) {
          stock[type]++;
        }
      }
    }
    
    console.log('í˜„ì¬ ì¬ê³  í˜„í™©:', stock);
    return stock;
    
  } catch (error) {
    console.error('ì¬ê³  í™•ì¸ ì˜¤ë¥˜:', error);
    return null;
  }
}
