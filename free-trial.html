<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>팝업 진단 테스트</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .test-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .test-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .result {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .success { border-color: #4CAF50; background: #e8f5e8; }
        .error { border-color: #f44336; background: #ffebee; }
        .warning { border-color: #ff9800; background: #fff3e0; }
        
        input[type="email"] {
            width: 300px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin: 10px;
        }
        
        .step {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #4CAF50;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <h1>🔍 LittleScienceAI 팝업 진단 테스트</h1>
    
    <div class="test-container">
        <h2>1단계: 기본 팝업 테스트</h2>
        <p>브라우저 팝업 차단 여부를 확인합니다.</p>
        <button class="test-btn" onclick="testBasicPopup()">기본 팝업 테스트</button>
        <div id="basicResult" class="result"></div>
    </div>
    
    <div class="test-container">
        <h2>2단계: Google Apps Script URL 접근 테스트</h2>
        <p>실제 스크립트 URL에 직접 접근해서 응답을 확인합니다.</p>
        <button class="test-btn" onclick="testScriptAccess()">스크립트 접근 테스트</button>
        <div id="scriptResult" class="result"></div>
    </div>
    
    <div class="test-container">
        <h2>3단계: 파라미터 포함 팝업 테스트</h2>
        <p>실제 무료체험과 동일한 파라미터로 팝업을 테스트합니다.</p>
        <input type="email" id="testEmail" placeholder="테스트용 이메일" value="test@example.com">
        <button class="test-btn" onclick="testParameterPopup()">파라미터 팝업 테스트</button>
        <div id="paramResult" class="result"></div>
    </div>
    
    <div class="test-container">
        <h2>4단계: postMessage 통신 테스트</h2>
        <p>팝업과 부모 창 간의 메시지 통신을 테스트합니다.</p>
        <button class="test-btn" onclick="testPostMessage()">postMessage 테스트</button>
        <div id="messageResult" class="result"></div>
    </div>
    
    <div class="test-container">
        <h2>5단계: 전체 프로세스 테스트</h2>
        <p>실제 무료체험 신청과 동일한 전체 과정을 테스트합니다.</p>
        <input type="email" id="realTestEmail" placeholder="실제 테스트할 이메일">
        <button class="test-btn" onclick="testFullProcess()">전체 프로세스 테스트</button>
        <div id="fullResult" class="result"></div>
    </div>

    <script>
        // 현재 사용 중인 Google Apps Script URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxk2od85OXtH8n1eKmsnKABkzwvx6u_S1IEoTI4-Ru69Iwr-PswaCQhFXALGGWyVdJVrg/exec';
        
        // postMessage 리스너 등록
        window.addEventListener('message', function(event) {
            console.log('📨 postMessage 수신:', event.data);
            
            if (event.data && event.data.type === 'FREE_TRIAL_RESULT') {
                const result = document.getElementById('messageResult');
                result.className = 'result success';
                result.textContent = `✅ postMessage 수신 성공!\n상태: ${event.data.status}\n메시지: ${event.data.message}`;
            }
        });
        
        // 1단계: 기본 팝업 테스트
        function testBasicPopup() {
            const result = document.getElementById('basicResult');
            result.textContent = '팝업 테스트 중...';
            
            try {
                const popup = window.open('about:blank', 'testPopup', 'width=400,height=300');
                
                if (popup) {
                    result.className = 'result success';
                    result.textContent = '✅ 팝업 열기 성공! 브라우저 차단 없음';
                    
                    popup.document.write(`
                        <html>
                            <body style="font-family: Arial; text-align: center; padding: 40px;">
                                <h2>✅ 팝업 테스트 성공!</h2>
                                <p>브라우저에서 팝업이 정상적으로 열렸습니다.</p>
                                <button onclick="window.close()">창 닫기</button>
                            </body>
                        </html>
                    `);
                } else {
                    result.className = 'result error';
                    result.textContent = '❌ 팝업 차단됨! 브라우저 설정에서 팝업 허용 필요';
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `❌ 팝업 테스트 실패: ${error.message}`;
            }
        }
        
        // 2단계: Google Apps Script URL 접근 테스트
        async function testScriptAccess() {
            const result = document.getElementById('scriptResult');
            result.textContent = 'Google Apps Script 접근 테스트 중...';
            
            try {
                // 단순 GET 요청으로 스크립트 응답 확인
                const response = await fetch(SCRIPT_URL);
                
                if (response.ok) {
                    const text = await response.text();
                    result.className = 'result success';
                    result.textContent = `✅ 스크립트 접근 성공!\n응답 길이: ${text.length}자\n응답 시작: ${text.substring(0, 200)}...`;
                } else {
                    result.className = 'result error';
                    result.textContent = `❌ 스크립트 접근 실패\nHTTP 상태: ${response.status}\n오류: ${response.statusText}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `❌ 스크립트 접근 오류: ${error.message}`;
            }
        }
        
        // 3단계: 파라미터 포함 팝업 테스트
        function testParameterPopup() {
            const result = document.getElementById('paramResult');
            const email = document.getElementById('testEmail').value;
            
            if (!email) {
                result.className = 'result warning';
                result.textContent = '⚠️ 이메일을 입력해주세요';
                return;
            }
            
            result.textContent = '파라미터 팝업 테스트 중...';
            
            try {
                const params = new URLSearchParams({
                    action: 'free_trial',
                    userEmail: email,
                    userIP: 'test_ip',
                    deviceFingerprint: 'test_fingerprint'
                });
                
                const popupUrl = `${SCRIPT_URL}?${params}`;
                console.log('팝업 URL:', popupUrl);
                
                const popup = window.open(popupUrl, 'paramTestPopup', 'width=500,height=400');
                
                if (popup) {
                    result.className = 'result success';
                    result.textContent = `✅ 파라미터 팝업 열기 성공!\nURL: ${popupUrl}`;
                    
                    // 팝업이 닫혔는지 주기적으로 확인
                    const checkClosed = setInterval(() => {
                        if (popup.closed) {
                            clearInterval(checkClosed);
                            result.textContent += '\n\n팝업이 닫혔습니다. 개발자 도구 콘솔에서 postMessage 수신 여부를 확인하세요.';
                        }
                    }, 1000);
                } else {
                    result.className = 'result error';
                    result.textContent = '❌ 파라미터 팝업 차단됨!';
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `❌ 파라미터 팝업 오류: ${error.message}`;
            }
        }
        
        // 4단계: postMessage 통신 테스트
        function testPostMessage() {
            const result = document.getElementById('messageResult');
            result.textContent = 'postMessage 테스트 준비 중...';
            result.className = 'result warning';
            
            // 테스트용 팝업 생성
            const popup = window.open('about:blank', 'messageTestPopup', 'width=400,height=300');
            
            if (popup) {
                popup.document.write(`
                    <html>
                        <body style="font-family: Arial; text-align: center; padding: 20px;">
                            <h3>postMessage 테스트</h3>
                            <button onclick="sendTestMessage()">테스트 메시지 전송</button>
                            <script>
                                function sendTestMessage() {
                                    if (window.opener) {
                                        window.opener.postMessage({
                                            type: 'FREE_TRIAL_RESULT',
                                            status: 'SUCCESS',
                                            email: 'test@example.com',
                                            message: 'postMessage 테스트 성공!'
                                        }, '*');
                                        
                                        setTimeout(() => window.close(), 1000);
                                    }
                                }
                            </script>
                        </body>
                    </html>
                `);
                
                result.textContent = '✅ 테스트 팝업이 열렸습니다. 팝업에서 "테스트 메시지 전송" 버튼을 클릭하세요.';
            } else {
                result.className = 'result error';
                result.textContent = '❌ 테스트 팝업을 열 수 없습니다.';
            }
        }
        
        // 5단계: 전체 프로세스 테스트
        async function testFullProcess() {
            const result = document.getElementById('fullResult');
            const email = document.getElementById('realTestEmail').value;
            
            if (!email || !isValidEmail(email)) {
                result.className = 'result warning';
                result.textContent = '⚠️ 올바른 이메일을 입력해주세요';
                return;
            }
            
            result.textContent = '전체 프로세스 테스트 시작...\n';
            result.className = 'result';
            
            try {
                // IP 가져오기 테스트
                result.textContent += '1. IP 주소 확인 중...\n';
                let userIP = 'unknown';
                try {
                    const ipResponse = await fetch('https://api.ipify.org?format=json');
                    const ipData = await ipResponse.json();
                    userIP = ipData.ip || 'unknown';
                    result.textContent += `   ✅ IP 확인 성공: ${userIP}\n`;
                } catch (ipError) {
                    result.textContent += `   ⚠️ IP 확인 실패: ${ipError.message}\n`;
                }
                
                // 디바이스 핑거프린트 생성
                result.textContent += '2. 디바이스 핑거프린트 생성...\n';
                const fingerprint = generateDeviceFingerprint();
                result.textContent += `   ✅ 핑거프린트: ${fingerprint}\n`;
                
                // 팝업 URL 생성
                result.textContent += '3. 팝업 URL 생성...\n';
                const params = new URLSearchParams({
                    action: 'free_trial',
                    userEmail: email,
                    userIP: userIP,
                    deviceFingerprint: fingerprint
                });
                
                const popupUrl = `${SCRIPT_URL}?${params}`;
                result.textContent += `   ✅ URL 생성 완료\n`;
                
                // 팝업 열기
                result.textContent += '4. 팝업 열기...\n';
                const popup = window.open(popupUrl, 'fullTestPopup', 'width=500,height=400');
                
                if (popup) {
                    result.className = 'result success';
                    result.textContent += '   ✅ 팝업 열기 성공!\n\n';
                    result.textContent += '이제 팝업에서 처리 결과를 기다리세요...\n';
                    result.textContent += 'postMessage로 결과가 전달되면 "4단계" 결과창에 표시됩니다.';
                } else {
                    result.className = 'result error';
                    result.textContent += '   ❌ 팝업 차단됨!\n';
                }
                
            } catch (error) {
                result.className = 'result error';
                result.textContent += `❌ 전체 프로세스 오류: ${error.message}`;
            }
        }
        
        // 유틸리티 함수들
        function generateDeviceFingerprint() {
            try {
                const fingerprint = [
                    navigator.userAgent.slice(0, 50),
                    navigator.language,
                    screen.width + 'x' + screen.height,
                    new Date().getTimezoneOffset()
                ].join('|');
                
                return btoa(fingerprint).slice(0, 20);
            } catch (error) {
                return 'unknown';
            }
        }
        
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        console.log('🔍 진단 도구 로드 완료');
        console.log('Google Apps Script URL:', SCRIPT_URL);
    </script>
</body>
</html>
